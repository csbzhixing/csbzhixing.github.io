
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>AFNetworking 学习笔记 1  | 之行海涯</title>

<meta name="author" content="之行"> 

<meta name="description" content="从3.0开始 一转眼，AF已经更新到了3.0版本。目前cocoapods上的最新版本是3.0 beta1。在3.0的版本里面，AF全面地使用NSURLSession代替了NSURLConnection。之前花了一些时间学习NSURLSession，在这里的学习终于派上了用场。在这里主要学习3. &hellip;"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="之行海涯" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>



<body>
	<header id="header" class="inner"><h1><a href="/">之行海涯</a></h1>
<h4>在这里记录一点一滴的成长</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:csbzhixing.github.io">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">AFNetworking 学习笔记 1</h2>
	<div class="entry-content"><h2>从3.0开始</h2>

<p>一转眼，AF已经更新到了3.0版本。目前cocoapods上的最新版本是3.0 beta1。在3.0的版本里面，AF全面地使用<code>NSURLSession</code>代替了<code>NSURLConnection</code>。之前花了一些时间学习<code>NSURLSession</code>，在这里的学习终于派上了用场。在这里主要学习3.0版本的使用。希望在项目中能够顺利地过度到AFNetwoking 3.0版本。此外，随着Objective-c慢慢被Swift替代，AFNetworking 3.0可能是最后一个大版本更新。本文会一直随着AN的更新继续更新，也是一个不断学习的过程。</p>

<h2>结构</h2>

<p>在3.0时代，AFN精简了结构，全面使用了<code>NSURLSession</code>。</p>

<p><img src="/media/14451531667191.jpg" alt="" />
beta1里面只剩下了当前几个Manager。</p>

<p><code>AFHTTPSessionManager</code>是<code>AFURLSessionManager</code>的子类。</p>

<h2>AFURLSessionManager</h2>

<p><code>AFURLSessionManager</code>实现了以下几种<code>NSURLSession</code>的代理方法</p>

<h4><code>NSURLSessionDelegate</code></h4>

<ul>
<li><code>URLSession:didBecomeInvalidWithError:</code></li>
<li><code>URLSession:didReceiveChallenge:completionHandler:</code></li>
<li><code>URLSessionDidFinishEventsForBackgroundURLSession:</code></li>
</ul>


<h4><code>NSURLSessionTaskDelegate</code></h4>

<ul>
<li><code>URLSession:willPerformHTTPRedirection:newRequest:completionHandler:</code></li>
<li><code>URLSession:task:didReceiveChallenge:completionHandler:</code></li>
<li><code>URLSession:task:didSendBodyData:totalBytesSent:totalBytesExpectedToSend:</code></li>
<li><code>URLSession:task:didCompleteWithError:</code></li>
</ul>


<h4><code>NSURLSessionDataDelegate</code></h4>

<ul>
<li><code>URLSession:dataTask:didReceiveResponse:completionHandler:</code></li>
<li><code>URLSession:dataTask:didBecomeDownloadTask:</code></li>
<li><code>URLSession:dataTask:didReceiveData:</code></li>
<li><code>URLSession:dataTask:willCacheResponse:completionHandler:</code></li>
</ul>


<h4><code>NSURLSessionDownloadDelegate</code></h4>

<ul>
<li><code>URLSession:downloadTask:didFinishDownloadingToURL:</code></li>
<li><code>URLSession:downloadTask:didWriteData:totalBytesWritten:totalBytesWritten:totalBytesExpectedToWrite:</code></li>
<li><code>URLSession:downloadTask:didResumeAtOffset:expectedTotalBytes:</code></li>
</ul>


<h3>成员</h3>

<h4>属性</h4>

<p>在<code>AFURLSessionManager</code>中，主要的三个属性如下</p>

<p><img src="/media/14451544109695.jpg" alt="" /></p>

<p><code>session</code>实现了会话，<code>operationQueue</code>是一个操作队列。<code>responseSerializer</code>是实现了<code>AFURLResponseSerialization</code>协议的一个对象。</p>

<hr />

<p>Manager中还包括了安全协议的对象和连通性的对象。这两个类将在后面谈到。</p>

<p><img src="/media/14451545558576.jpg" alt="" /></p>

<hr />

<p>下面是Task的内容，包含与当前<code>Session</code>中</p>

<p><img src="/media/14451547233232.jpg" alt="" /></p>

<hr />

<p>回调块队列，包括了在主队列和私有队列的两个部分</p>

<p><img src="/media/14451548418504.jpg" alt="" /></p>

<h4>方法</h4>

<p> 初始化方法</p>

<p> <img src="/media/14455211888103.jpg" alt="" /></p>

<hr />

<p>创建一个<code>NSURLSessionDataTask</code>数据性任务</p>

<p><img src="/media/14455212385758.jpg" alt="" /></p>

<hr />

<p>创建<code>`NSURLSessionUploadTask</code> 上传任务</p>

<p><img src="/media/14455213126912.jpg" alt="" />
<img src="/media/14455213190110.jpg" alt="" /></p>

<hr />

<p>创建<code>NSURLSessionDownloadTask</code> 下载任务</p>

<p><img src="/media/14455213738134.jpg" alt="" />
<img src="/media/14455213826398.jpg" alt="" /></p>

<hr />

<p>获得一个特定任务的<code>progress进度</code></p>

<p><img src="/media/14455214651069.jpg" alt="" />
<img src="/media/14455214692883.jpg" alt="" />
<img src="/media/14455214742512.jpg" alt="" /></p>

<hr />

<p><code>Session Delegate Callbacks 设置会话代理回调</code></p>

<p><img src="/media/14455217046547.jpg" alt="" />
<img src="/media/14455217113671.jpg" alt="" /></p>

<p><code>Task Delegate Callbacks 设置任务代理回调</code></p>

<p>当任务需要一个新的请求体发送给服务器的时候。
<img src="/media/14455219470133.jpg" alt="" /></p>

<p>当HTTP请求回调有重定向的的话设置这个Block
<img src="/media/14455219533707.jpg" alt="" /></p>

<p>当一个请求需要特别的鉴权的时候设置这个challenge
<img src="/media/14455219599178.jpg" alt="" /></p>

<p>设置一个block去追踪上传进度</p>

<p><img src="/media/14455658294340.jpg" alt="" /></p>

<p>设置一个block当任务完成后执行
<img src="/media/14455658635389.jpg" alt="" /></p>

<h4><code>Setting Data Task Delegate Callbacks 设置数据任务代理的回调</code></h4>

<p>设置一个在数据任务获得response的时候回调block</p>

<p><img src="/media/14455662011592.jpg" alt="" /></p>

<p>设置一个block当数据任务变成下载的任务的时候执行</p>

<p><img src="/media/14455662317310.jpg" alt="" /></p>

<p>设置一个block当数据任务获得到数据的时候
<img src="/media/14455662434172.jpg" alt="" /></p>

<p>设置一个block绝对是否缓存数据任务</p>

<p><img src="/media/14455662958106.jpg" alt="" /></p>

<h4><code>Download Task Delegate Callbacks 下载任务代理回调</code></h4>

<p>设置block当下载任务完成下载后</p>

<p><img src="/media/14455666105437.jpg" alt="" /></p>

<p>设置block去追踪下载任务进度情况</p>

<p><img src="/media/14455666301025.jpg" alt="" /></p>

<p>设置block当下载任务执行/恢复的时候 执行</p>

<p><img src="/media/14455666958363.jpg" alt="" /></p>

<p>头文件的内容基本就是以上的了。可以看到整个AF的体系非常清晰完整，没有多余的东西，头文件只暴露了应该暴露的东西，值得我们去学习。</p>

<h2>使用的例子</h2>

<h3>使用<code>AFURLSessionManager</code></h3>

<p>从源码中可以看到，<code>AFURLSessionManager</code>实现了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Objective-c'><span class='line'><span class="bp">NSURLSessionDelegate</span><span class="p">,</span> <span class="bp">NSURLSessionTaskDelegate</span><span class="p">,</span> <span class="bp">NSURLSessionDataDelegate</span><span class="p">,</span> <span class="bp">NSURLSessionDownloadDelegate</span><span class="p">,</span> <span class="bp">NSSecureCoding</span><span class="p">,</span> <span class="bp">NSCopying</span>
</span></code></pre></td></tr></table></div></figure>


<p>首先需要设置url和NSURLConfirguration</p>

<p>这里是使用百度API商店的公开API
<img src="/media/14453928846040.jpg" alt="" /></p>

<p>然后初始化Manager<img src="/media/14453929237373.jpg" alt="" /></p>

<p>设置ResponseSerializer
<img src="/media/14453931412125.jpg" alt="" /></p>

<p>初始化request
<img src="/media/14453932169242.jpg" alt="" /></p>

<p>对request进行相关设置
<img src="/media/14453932396509.jpg" alt="" /></p>

<p>根据request生成对应的<code>NSURLSessionTask</code>。
<img src="/media/14453935717679.jpg" alt="" /></p>

<p>执行任务
<img src="/media/14453936154108.jpg" alt="" /></p>

<p>来看看执行后的信息</p>

<p><img src="/media/14453937344699.jpg" alt="" /></p>

<p>这里由于使用的<code>AFHTTPResponseSerializer</code>(API的问题，仅仅支持text/plain)所以在获取的数据后，我们自己要json序列化。如果是设计好的API,直接使用<code>AFJSONRequestSerializer</code>就可以在回调中获取到json格式的数据了。</p>

<p>可以看到，整个使用还是很方便的。我们可以根据自己的需求配置不同设置。</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-10-23T10:31:15+08:00" pubdate data-updated="true"></time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/network/'>network</a>

</div>


	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    之行

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>
