<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="hello world" />





  <link rel="alternate" href="/atom.xml" title="å­¦æµ·æ— æ¶¯" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="ä¹‹è¡Œçš„åšå®¢">
<meta property="og:type" content="website">
<meta property="og:title" content="å­¦æµ·æ— æ¶¯">
<meta property="og:url" content="http://csbzhixing.github.io/index.html">
<meta property="og:site_name" content="å­¦æµ·æ— æ¶¯">
<meta property="og:description" content="ä¹‹è¡Œçš„åšå®¢">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="å­¦æµ·æ— æ¶¯">
<meta name="twitter:description" content="ä¹‹è¡Œçš„åšå®¢">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"hide"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://csbzhixing.github.io/"/>





  <title> å­¦æµ·æ— æ¶¯ </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">å­¦æµ·æ— æ¶¯</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            æœç´¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://csbzhixing.github.io/2017/01/10/æŒä¹…åŒ–å­¦ä¹ ç³»åˆ—2/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="csbzhixing">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://p3.pstatp.com/large/ab000310321818ab99.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="å­¦æµ·æ— æ¶¯">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="å­¦æµ·æ— æ¶¯" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/10/æŒä¹…åŒ–å­¦ä¹ ç³»åˆ—2/" itemprop="url">
                  æŒä¹…åŒ–å­¦ä¹ ç³»åˆ—2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-10T23:10:33+08:00">
                2017-01-10
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="PINCache"><a href="#PINCache" class="headerlink" title="PINCache"></a>PINCache</h1><p>ç¬¬äºŒç¯‡æ˜¯å…³äºæœ€ç»å…¸çš„KVç¼“å­˜è§£å†³æ–¹æ¡ˆ<code>PINCache</code></p>
<h2 id="å®¢æˆ·ç«¯çš„å­˜å‚¨"><a href="#å®¢æˆ·ç«¯çš„å­˜å‚¨" class="headerlink" title="å®¢æˆ·ç«¯çš„å­˜å‚¨"></a>å®¢æˆ·ç«¯çš„å­˜å‚¨</h2><p>åœ¨æ­£å¼è®²è§£<code>PINCache</code>å‰ï¼Œå…ˆæ¥è°ˆè°ˆå®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™éœ€è¦åšå­˜å‚¨ã€‚</p>
<p>æ€»æ‰€å‘¨çŸ¥ï¼Œç°åœ¨çš„APPè¶Šæ¥è¶Šä¾èµ–ç½‘ç»œï¼Œåœ¨ç¦»å¼€ç½‘ç»œçš„æƒ…å†µä¸‹ï¼Œç»å¤§å¤šæ•°çš„APPéƒ½æˆäº†æ‘†è®¾ã€‚ç„¶è€Œï¼Œä¼˜ç§€çš„APPå·²ç»æœ‰è‡ªå·±çš„ä¸€å¥—è®¾è®¡ï¼Œé¿å…åœ¨æ— ç½‘æˆ–è€…å¼±ç½‘çš„æƒ…å†µä¸‹å®Œå…¨å¤±å»ä½œç”¨ã€‚ä¾‹å¦‚å¾®ä¿¡è¿™æ ·çš„å¼ºç½‘ç»œè¦æ±‚çš„APP,åœ¨å¤±å»ç½‘ç»œçš„æƒ…å†µä¾ç„¶èƒ½å¤Ÿæµè§ˆæœ¬åœ°ç¼“å­˜çš„èŠå¤©ä¿¡æ¯å’Œæœ‹å‹åœˆè®°å½•ã€‚ä¼˜ç§€çš„APPï¼Œåº”è¯¥æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚ï¼Œé€‰æ‹©åˆé€‚çš„å­˜å‚¨æ–¹æ¡ˆã€‚å¯¹äºä¸€èˆ¬ä½“é‡çš„APPæ¥è¯´ï¼Œåˆ©ç”¨KVå½¢å¼çš„å­˜å‚¨æ˜¯æœ€å¥½ä¸è¿‡çš„é€‰æ‹©ã€‚</p>
<p>KVï¼Œå³Key-Valueå½¢å¼çš„å­˜å‚¨ã€‚é€šå¸¸å®¢æˆ·ç«¯çš„ä¿¡æ¯æ˜¯ç”±åç«¯ç»™å‡ºçš„jsonè§£æçš„,ä½¿ç”¨Key-Valueæ­£æ˜¯æ–¹ä¾¿äº†è¿™ç§æ ¼å¼ã€‚</p>
<h2 id="PINCache-1"><a href="#PINCache-1" class="headerlink" title="PINCache"></a>PINCache</h2><p><code>PINCache</code>æ˜¯è„±èƒäº<code>TMCache</code>ï¼Œè§£å†³äº†<code>TMCache</code>ä¸­çš„çº¿ç¨‹æ­»é”é—®é¢˜ã€‚<code>PINCache</code>ä¸­ä¾ç„¶è®¾è®¡äº†<code>memoryCache</code>å’Œ<code>diskCache</code>ä¸¤ç§ï¼Œåˆ†åˆ«è§£å†³äº†ä¸´æ—¶å­˜å‚¨å’Œé•¿æœŸæŒä¹…åŒ–çš„é—®é¢˜ã€‚<br>åœ¨<code>PINCache</code>çš„githubä¸»é¡µä¸Šï¼Œæå‡ºåœ¨iOSä¸Šå¦‚æœæ²¡æœ‰ç‰¹åˆ«çš„æƒ…å†µï¼Œå°½å¯èƒ½ä½¿ç”¨<code>diskCache</code>ï¼ŒåŸå› æ˜¯æ¯æ¬¡iOSåº”ç”¨å¯åŠ¨ï¼Œéƒ½ä¼šé€ æˆ<code>memoryCache</code>ä¸­çš„å†…å®¹è¢«æ¸…ç©ºã€‚åœ¨ä¸‹é¢ï¼Œä¼šå¯¹æ¯”ä¸‹å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜çš„ä¼˜ç¼ºç‚¹ï¼Œä»¥åŠ<code>PINCache</code>æ˜¯å¦‚ä½•å®ç°çš„ï¼Œ</p>
<h2 id="æ–‡ä»¶ç»“æ„"><a href="#æ–‡ä»¶ç»“æ„" class="headerlink" title="æ–‡ä»¶ç»“æ„"></a>æ–‡ä»¶ç»“æ„</h2><p><img src="../media/14838580770949.jpg" alt=""></p>
<p>ä»å›¾ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œ<code>PINCache</code>çš„å®ç°å¹¶ä¸å¤æ‚ï¼Œé™¤å»<code>PINCache</code>æœ¬èº«å®ç°å¯¹å¤–çš„æ–¹æ³•å¤–ï¼Œæ€»å…±åªæœ‰å…«ä¸ªå®ç°æ–‡ä»¶ã€‚</p>
<h3 id="PINMemoryCache"><a href="#PINMemoryCache" class="headerlink" title="PINMemoryCache"></a>PINMemoryCache</h3><p><code>PINMemoryCache</code>ä¸ºå®ç°å†…å­˜ç¼“å­˜çš„ç±»ã€‚ä»€ä¹ˆæ˜¯å†…å­˜ç¼“å­˜ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºé€šè¿‡ä¸€ä¸ª<code>NSMutableDictionary</code>æ¥ä¸´æ—¶å­˜å‚¨å¯¹è±¡ã€‚å®ç°ä¸€ä¸ªå†…å­˜ç¼“å­˜éš¾åº¦ä¸å¤§ï¼Œé€šå¸¸éœ€è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªäº‹æƒ…ï¼š</p>
<ol>
<li>é€‰æ‹©åˆé€‚çš„å­˜å‚¨ç»“æ„</li>
<li>é€‰æ‹©å’Œå®ç°å¯¹åº”çš„è¯»å†™æ–¹æ³•</li>
<li>é€‰æ‹©å’Œå®ç°æ·˜æ±°æ–¹æ³•</li>
<li>å¤„ç†ç³»ç»Ÿå†…å­˜è­¦å‘Š</li>
</ol>
<p>äº†è§£äº†ä»¥ä¸Šæ­¥éª¤ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹<code>PINMemoryCache</code>æ˜¯æ€ä¹ˆè§£å†³ä¸Šé¢çš„é—®é¢˜</p>
<ol>
<li>é€‰æ‹©<code>NSMutableDictionary</code>ä½œä¸ºå­˜å‚¨ç»“æ„</li>
<li>é‡‡ç”¨<code>NSMutableDictionary</code>çš„è¯»å†™æ–¹æ³•</li>
<li>é€šè¿‡ä¸¤ä¸ª<code>NSMutableDictionary</code>åˆ†åˆ«è®°å½•<code>date</code>å’Œ<code>cost</code>,å®ç°æ—¶é—´å’Œå†…å®¹çš„ç®¡ç†ã€‚</li>
<li>æ”¶åˆ°å†…å­˜è­¦å‘Šåï¼Œæ¸…ç©ºå†…å­˜ä¸­æ‰€æœ‰çš„å¯¹è±¡ï¼Œæ¸…ç©ºç¼“å­˜ã€‚</li>
</ol>
<p>çœ‹ä¸Šå»ä¸éš¾ï¼Ÿåœ¨ç¬”è€…çœ‹æ¥ï¼Œå®ç°å†…å­˜ç¼“å­˜çš„éš¾åº¦ä¸»è¦æ˜¯2ï¼Œ3ç‚¹ã€‚åœ¨è¿™é‡Œï¼Œ<code>PINMemoryCache</code>ä¸»è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•è§£å†³å¤šçº¿ç¨‹å®‰å…¨çš„é—®é¢˜ï¼Œä»¥åŠç¼“å­˜æ·˜æ±°é—®é¢˜ã€‚</p>
<h4 id="å¤šçº¿ç¨‹å®‰å…¨"><a href="#å¤šçº¿ç¨‹å®‰å…¨" class="headerlink" title="å¤šçº¿ç¨‹å®‰å…¨"></a>å¤šçº¿ç¨‹å®‰å…¨</h4><p>ç”±äºç¼“å­˜çš„ç‰¹æ®Šæ€§ï¼Œè¯»å†™å¿…é¡»è€ƒè™‘åˆ°å¤šçº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹æ”¹å˜äº†ç¼“å­˜ä¸­çš„æŸä¸ªå€¼ï¼Œè€Œåˆ«çš„çº¿æ­£å¥½éœ€è¦è¿™ä¸ªå€¼ï¼Œå¤„ç†ä¸å¥½è½»åˆ™é€ æˆæ•°æ®å‡ºé”™ï¼Œé‡åˆ™é€ æˆç¨‹åºå´©æºƒã€‚</p>
<p>åœ¨<code>PINMemoryCache</code>ä¸­ï¼Œä½¿ç”¨äº†<code>pthread_mutex_t</code>æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>
<p><code>pthread_mutex_t</code>ä¸ºäº’æ–¥é”ï¼Œå½“é”ä¸Šçš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹å°±æ— æ³•è®¿é—®è¢«é”ä¸Šçš„èµ„æº</p>
<p>ä½¿ç”¨<code>pthread_mutex_t</code>éœ€è¦æ³¨æ„å‡ ç‚¹ã€‚</p>
<p><strong>å¿…é¡»åœ¨<code>dealloc</code>æ–¹æ³•ä¸­ä¸»åŠ¨é‡Šæ”¾</strong></p>
<pre><code class="objc">
- (void)dealloc
{
    [[NSNotificationCenter defaultCenter] removeObserver:self];

    __unused int result = pthread_mutex_destroy(&amp;_mutex);
    NSCAssert(result == 0, @&quot;Failed to destroy lock in PINMemoryCache %p. Code: %d&quot;, (void *)self, result);
}
</code></pre>
<p> å•ç‹¬ä½¿ç”¨<code>pthread_mutex_t</code>å®¹æ˜“é€ æˆ<strong>æ­»é”</strong>ï¼ŒåŒæ—¶ä¹Ÿå‘ä½ é€ æˆæ•ˆç‡ä¸é«˜ï¼Œå¯ä»¥é€šè¿‡å®ç°å¯¹åº”çš„é€’å½’é”æ¥é¿å…</p>
<pre><code class="objc">pthread_mutexattr_t attr;
pthread_mutexattr_init(&amp;attr);
pthread_mutexattr_settype(&amp;attr,PTHREAD_MUTEX_RECURSIVE);
pthread_mutex_init(&amp;lock, &amp;attr);
pthread_mutexattr_destroy(&amp;attr);
</code></pre>
<p>åœ¨å®Œæˆé”çš„åˆå§‹åŒ–åï¼Œå°±éœ€è¦è€ƒè™‘ä»€ä¹ˆæ—¶å€™è¦åŠ é”è§£é”äº†</p>
<p>ä¸ºäº†é¿å…<strong>data race</strong>çš„æƒ…å†µï¼Œåœ¨è¿™é‡Œï¼Œ<code>PINMemoryCache</code>é€‰æ‹©äº†å¯¹æ‰€æœ‰è¯»å†™æ“ä½œéƒ½è¿›è¡ŒåŠ é”ã€‚åŒæ—¶ï¼Œé‡‡ç”¨å‰¯æœ¬çš„å½¢å¼é¿å…è¯»å–çš„æ•°æ®è¢«ç¯¡æ”¹ã€‚</p>
<pre><code class="objc">- (__nullable id)objectForKey:(NSString *)key
{
    if (!key)
        return nil;

    NSDate *now = [[NSDate alloc] init];
    [self lock];
        id object = nil;
        // If the cache should behave like a TTL cache, then only fetch the object if there&#39;s a valid ageLimit and  the object is still alive
        if (!self-&gt;_ttlCache || self-&gt;_ageLimit &lt;= 0 || fabs([[_dates objectForKey:key] timeIntervalSinceDate:now]) &lt; self-&gt;_ageLimit) {
            object = _dictionary[key];
        }
    [self unlock];

    if (object) {
        [self lock];
            _dates[key] = now;
        [self unlock];
    }

    return object;
}


- (void)setObject:(id)object forKey:(NSString *)key withCost:(NSUInteger)cost
{
    if (!key || !object)
        return;

    [self lock];
        PINMemoryCacheObjectBlock willAddObjectBlock = _willAddObjectBlock;
        PINMemoryCacheObjectBlock didAddObjectBlock = _didAddObjectBlock;
        NSUInteger costLimit = _costLimit;
    [self unlock];

    if (willAddObjectBlock)
        willAddObjectBlock(self, key, object);

    [self lock];
        NSNumber* oldCost = _costs[key];
        if (oldCost)
            _totalCost -= [oldCost unsignedIntegerValue];

        _dictionary[key] = object;
        _dates[key] = [[NSDate alloc] init];
        _costs[key] = @(cost);

        _totalCost += cost;
    [self unlock];

    if (didAddObjectBlock)
        didAddObjectBlock(self, key, object);

    if (costLimit &gt; 0)
        [self trimToCostByDate:costLimit];
}
</code></pre>
<p>é€šè¿‡è¿™ä¸¤ä¸ªè¯»å†™æ–¹æ³•ï¼Œæˆ‘ä»¬å‘ç°ï¼Œ<code>PINMemoryCache</code>å¯¹ä»»ä½•æ¶‰åŠå±æ€§æ“ä½œçš„åœ°æ–¹éƒ½è¿›è¡Œäº†é”æ“ä½œï¼Œé¿å…äº†<strong>data race</strong>çš„æƒ…å†µã€‚</p>
<h4 id="ç¼“å­˜æ·˜æ±°"><a href="#ç¼“å­˜æ·˜æ±°" class="headerlink" title="ç¼“å­˜æ·˜æ±°"></a>ç¼“å­˜æ·˜æ±°</h4><p>ç¼“å­˜æ·˜æ±°ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸‰ç‚¹ã€‚å¦‚æœä¿è¯ç¼“å­˜ä¸­æ•°æ®æœ‰æ•ˆæ€§ï¼Œä¿è¯ç¼“å­˜æç¬‘çš„åˆ©ç”¨æ˜¯æ‰€æœ‰ç¼“å­˜åº”è¯¥è€ƒè™‘çš„é—®é¢˜ã€‚é€šå¸¸æ¥è®²ï¼Œæˆ‘ä»¬åº”è¯¥ä»ç¼“å­˜åˆ©ç”¨ç‡ä¸Šæ¥ç€æ‰‹ï¼Œåªä¿ç•™å¸¸è¢«ä½¿ç”¨çš„æ•°æ®ï¼Œæ·˜æ±°é•¿æœŸä¸éœ€è¦çš„æ•°æ®ã€‚LRUå°±ä¼šå¸¸ç”¨çš„ä¸€ç§ç¼“å­˜æ·˜æ±°ç®—æ³•ã€‚åœ¨è¿™é‡Œï¼Œ<code>PINMemoryCache</code>é€šè¿‡æ—¶é—´å’Œç©ºé—´æ¥å®ç°çš„LRUç®—æ³•ã€‚</p>
<p>åœ¨ä¸Šé¢è´´å‡ºçš„è¯»å†™ä¸­ï¼Œè¯»çš„æ—¶å€™ï¼Œæ›´æ–°<code>date</code>ä¸­keyå¯¹åº”çš„æ—¶é—´ã€‚åœ¨å†™çš„æ—¶å€™ï¼Œè®°å½•æˆ–æ›´æ–°keyå¯¹åº”æ—¶é—´ã€‚</p>
<p>å½“è§¦å‘ç¼“å­˜åˆ é™¤æ“ä½œçš„æ—¶å€™ï¼Œä¼˜å…ˆåˆ é™¤å ç”¨ç©ºé—´å¤§å’Œä½¿ç”¨æ—¶é—´é å‰çš„çš„å†…å®¹ã€‚</p>
<p>è‡³æ­¤ï¼Œ<code>PINMemoryCache</code>çš„å†…å®¹åŸºæœ¬å°±åˆ†æå®Œäº†ã€‚å†…å­˜ç¼“å­˜çš„å®ç°ï¼Œåªè¦è€ƒè™‘æ¸…æ¥šä¸Šé¢åˆ—çš„å››ä¸ªå†…å®¹ï¼Œæˆ‘è®¤ä¸ºå°±ä¸éš¾åšåˆ°ï¼Œå‰©ä¸‹çš„å°±æ˜¯å®ç°ç»†èŠ‚å’Œæ€§èƒ½çš„è€ƒé‡äº†ã€‚</p>
<h2 id="PINDiskCache"><a href="#PINDiskCache" class="headerlink" title="PINDiskCache"></a>PINDiskCache</h2><p><code>PINDiskCache</code>å®ç°çš„ç£ç›˜ç¼“å­˜ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç£ç›˜çš„è¯»å–é€Ÿåº¦è¦è¿œå°äºå†…å­˜è¯»å–ã€‚å¤§é‡çš„ç£ç›˜I/Oä¼šé™ä½ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚è™½ç„¶å¦‚æ­¤ï¼Œé¢å¯¹å¤§ä½“é‡çš„æ•°æ®ä»¥åŠéœ€è¦é•¿æœŸå­˜å‚¨çš„æ•°æ®ï¼Œæˆ‘ä»¬åªèƒ½è€ƒè™‘å­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚åŒæ—¶ï¼Œç”±äºiOSç³»ç»Ÿçš„ç‰¹æ®Šæ€§ï¼Œé€‰æ‹©å­˜å‚¨åœ¨ç£ç›˜ä¸Šå¾€å¾€æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€é€‰æ‹©ã€‚</p>
<p>å’Œ<code>memory cache</code>ä¸åŒï¼Œç£ç›˜I/Oéœ€è¦è€ƒè™‘çš„é—®é¢˜è¦æ›´å¤šä¸€ç‚¹ï¼Œé™¤äº†ä¸Šé¢å†<code>memory cache</code>è®²åˆ°çš„å‡ ç‚¹å¤–ï¼Œè¿˜éœ€è¦è€ƒè™‘ä¸€ä¸‹å‡ ç‚¹ã€‚</p>
<ol>
<li>å®ç°æ–¹å¼ã€‚ç£ç›˜å­˜å‚¨ä¸€èˆ¬åˆ†ä¸ºä¸‰ç§ï¼šæ–‡ä»¶è¯»å†™ï¼Œæ•°æ®åº“ï¼Œmmapæ–‡ä»¶å†…å­˜æ˜ å°„ã€‚<code>PINDiskCache</code>ä½¿ç”¨çš„æ˜¯æ–‡ä»¶è¯»å†™çš„æ–¹å¼</li>
<li>å­˜å‚¨ä½ç½®ã€‚iOSæ–‡ä»¶ç³»ç»Ÿä¸åŒä½ç½®å»ºè®®å­˜å‚¨çš„å†…å®¹ä¸åŒã€‚æ˜¯æ”¾åœ¨cacheæ–‡ä»¶å¤¹ä¸­è¿˜æ˜¯tempæ–‡ä»¶ä¸­å–å†³äºå¼€å‘è€…å¯¹å­˜å‚¨æ–‡ä»¶çš„æ€åº¦ã€‚</li>
<li>æ–‡ä»¶ç³»ç»Ÿçš„ç»†èŠ‚ã€‚é¿å…å’Œå…¶ä»–æ–‡ä»¶äº§ç”Ÿå†²çªï¼Œå¿…é¡»è€ƒè™‘æ‹¥æœ‰è‡ªèº«çš„æ ‡è®°ã€‚</li>
<li>æ•°æ®åºåˆ—åŒ–</li>
</ol>
<p>çœ‹ä¸Šå»ç£ç›˜ç¼“å­˜çš„å®ç°çš„ç¡®è¦éš¾ä¸Šå¾ˆå¤šé—®é¢˜ï¼Œåœ¨å†…å­˜ç¼“å­˜çš„åŸºç¡€ä¸Šä¾ç„¶è¦è€ƒè™‘è¿™ä¹ˆå¤šé—®é¢˜ã€‚</p>
<p><code>PINDiskCache</code>åœ¨è¿™å››ä¸ªé—®é¢˜ä¸Šï¼Œå……åˆ†è€ƒè™‘äº†ocè¯­è¨€å·²ç»iOSå·²ç»MAC OSç³»ç»Ÿçš„ç‰¹æ€§ã€‚é¦–å…ˆé‡‡ç”¨æ–‡ä»¶è¯»å†™çš„æ–¹å¼ï¼Œä¾ç„¶è€ƒè™‘äº†æ•°æ®çš„ç‰¹æ€§ã€‚æ–‡ä»¶è¯»å†™çš„æ–¹å¼éå¸¸é€‚åˆç”¨äºå­˜å‚¨æ•°æ®è§„æ¨¡å°çš„æƒ…å†µï¼ŒåŒæ—¶å®ç°æ–¹ä¾¿ï¼Œæ€§èƒ½ç¨³å®šä¹Ÿæ˜¯é€‰æ‹©çš„åŸå› ä¹‹ä¸€ã€‚ä½†æ˜¯ä½¿ç”¨æ–‡ä»¶å­˜å‚¨ä¹Ÿæœ‰ä¸å°çš„å¼±ç‚¹ï¼šæ–¹ä¾¿æ‰©å±•ã€æ²¡æœ‰å…ƒæ•°æ®ã€éš¾ä»¥å®ç°è¾ƒå¥½çš„æ·˜æ±°ç®—æ³•ã€æ•°æ®ç»Ÿè®¡ç¼“æ…¢ã€‚</p>
<p>2ï¼Œ3ï¼Œ4ç‚¹å°†åœ¨ä¸‹é¢å®ç°ç»†èŠ‚ä¸­ä¼šè®²åˆ°ã€‚</p>
<h3 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h3><h4 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h4><p>çº¿ç¨‹å®‰å…¨ä¾ç„¶æ˜¯ç»•ä¸è¿‡å»çš„ä¸€ä¸ªåï¼Œåœ¨<code>PINDiskCache</code>é‡Œï¼Œé™¤äº†éœ€è¦å¯¹ä»˜ä¸€èˆ¬çš„<strong>data race</strong>ï¼Œè¿˜éœ€è¦å¤„ç†ç£ç›˜I/Oå¸¦æ¥çš„é—®é¢˜ã€‚</p>
<p>åœ¨è¿™é‡Œï¼Œ<code>PINDiskCache</code>ä½¿ç”¨çš„æ˜¯<code>NSConditionLock</code>æ¡ä»¶é”ã€‚åœ¨ä»£ç ä¸­æœ‰å¦‚ä¸‹å®šä¹‰ï¼š</p>
<pre><code class="objc">typedef NS_ENUM(NSUInteger, PINDiskCacheCondition) {
    PINDiskCacheConditionNotReady = 0,
    PINDiskCacheConditionReady = 1,
};
</code></pre>
<p>å¯è§ï¼Œæ¡ä»¶é”ä¸­å¹¶ä¸æ¶‰åŠåˆ°å…·ä½“çš„å®ä¾‹å¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªå¸¸é‡æ¥ä½œä¸ºé”çš„æ¡ä»¶ã€‚åœ¨è¿™é‡Œï¼Œä¸ªäººè®¤ä¸ºç›´æ¥ç”¨é€’å½’é”å·®åˆ«ä¹Ÿä¸æ˜¯å¾ˆå¤§ï¼Œä¸çŸ¥é“ä¸ºä½•è¿™é‡Œé€‰æ‹©ä½¿ç”¨äº†æ¡ä»¶é”ã€‚ï¼ˆæˆ–è®¸æœ‰ä¸€å¤©çŸ¥é“äº†ä¼šå›æ¥è¡¥ã€‚</p>
<p>åœ¨ä½¿ç”¨ä¸­ï¼Œæ‰€æœ‰å¯¹æˆå‘˜å˜é‡æ“ä½œçš„åœ°æ–¹éƒ½è¿›è¡Œçš„é”æ“ä½œã€‚(å®é™…ä¸Šæœ‰äº›åœ°æ–¹æ˜¯ä¸éœ€è¦ç”¨çš„)</p>
<h3 id="è¯»å†™"><a href="#è¯»å†™" class="headerlink" title="è¯»å†™"></a>è¯»å†™</h3><p>ç£ç›˜è¯»å†™å¦‚æœä¸æ³¨æ„æå…¶å®¹æ˜“é€ æˆæ­»é”ã€‚</p>
<p>å†™ï¼š</p>
<pre><code class="objc">- (void)setObject:(id &lt;NSCoding&gt;)object forKey:(NSString *)key fileURL:(NSURL **)outFileURL
{
    if (!key || !object)
        return;

    #if TARGET_OS_IPHONE
      NSDataWritingOptions writeOptions = NSDataWritingAtomic | self.writingProtectionOption;
    #else
      NSDataWritingOptions writeOptions = NSDataWritingAtomic;
    #endif

    NSURL *fileURL = [self encodedFileURLForKey:key];

    [self lock];
        PINDiskCacheObjectBlock willAddObjectBlock = self-&gt;_willAddObjectBlock;
        if (willAddObjectBlock) {
            [self unlock];
                willAddObjectBlock(self, key, object);
            [self lock];
        }

        //We unlock here so that we&#39;re not locked while serializing.
        [self unlock];
            NSData *data = _serializer(object, key);
        [self lock];

        NSError *writeError = nil;

        BOOL written = [data writeToURL:fileURL options:writeOptions error:&amp;writeError];
        PINDiskCacheError(writeError);

        if (written) {
            NSError *error = nil;
            NSDictionary *values = [fileURL resourceValuesForKeys:@[ NSURLContentModificationDateKey, NSURLTotalFileAllocatedSizeKey ] error:&amp;error];
            PINDiskCacheError(error);

            NSNumber *diskFileSize = [values objectForKey:NSURLTotalFileAllocatedSizeKey];
            if (diskFileSize) {
                NSNumber *prevDiskFileSize = [self-&gt;_sizes objectForKey:key];
                if (prevDiskFileSize) {
                    self.byteCount = self-&gt;_byteCount - [prevDiskFileSize unsignedIntegerValue];
                }
                [self-&gt;_sizes setObject:diskFileSize forKey:key];
                self.byteCount = self-&gt;_byteCount + [diskFileSize unsignedIntegerValue]; // atomic
            }
            NSDate *date = [values objectForKey:NSURLContentModificationDateKey];
            if (date) {
                [self-&gt;_dates setObject:date forKey:key];
            }

            if (self-&gt;_byteLimit &gt; 0 &amp;&amp; self-&gt;_byteCount &gt; self-&gt;_byteLimit)
                [self trimToSizeByDate:self-&gt;_byteLimit block:nil];
        } else {
            fileURL = nil;
        }

        PINDiskCacheObjectBlock didAddObjectBlock = self-&gt;_didAddObjectBlock;
        if (didAddObjectBlock) {
            [self unlock];
                didAddObjectBlock(self, key, object);
            [self lock];
        }
    [self unlock];

    if (outFileURL) {
        *outFileURL = fileURL;
    }
}
</code></pre>
<p>è¯»ï¼š</p>
<pre><code class="objc">- (__nullable id &lt;NSCoding&gt;)objectForKey:(NSString *)key fileURL:(NSURL **)outFileURL
{
    NSDate *now = [[NSDate alloc] init];

    if (!key)
        return nil;

    id &lt;NSCoding&gt; object = nil;
    NSURL *fileURL = [self encodedFileURLForKey:key];

    [self lock];
        if (!self-&gt;_ttlCache || self-&gt;_ageLimit &lt;= 0 || fabs([[_dates objectForKey:key] timeIntervalSinceDate:now]) &lt; self-&gt;_ageLimit) {
            // If the cache should behave like a TTL cache, then only fetch the object if there&#39;s a valid ageLimit and  the object is still alive
            NSData *objectData = [[NSData alloc] initWithContentsOfFile:[fileURL path]];

            if (objectData) {
              //Be careful with locking below. We unlock here so that we&#39;re not locked while deserializing, we re-lock after.
              [self unlock];
              @try {
                  object = _deserializer(objectData, key);
              }
              @catch (NSException *exception) {
                  NSError *error = nil;
                  [self lock];
                      [[NSFileManager defaultManager] removeItemAtPath:[fileURL path] error:&amp;error];
                  [self unlock];
                  PINDiskCacheError(error);
              }
              [self lock];
            }
            if (object &amp;&amp; !self-&gt;_ttlCache) {
                [self asynchronouslySetFileModificationDate:now forURL:fileURL];
            }
        }
    [self unlock];

    if (outFileURL) {
        *outFileURL = fileURL;
    }

    return object;
}
</code></pre>
<p> åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„åœ°æ–¹è§£é”ï¼Œä¹‹åå†ä¸Šé”ï¼Œç›®çš„æ˜¯é¿å…æ­»é”é—®é¢˜(åºåˆ—åŒ–å¤±è´¥ç­‰)ã€‚</p>
<p> åœ¨è¯»å†™ä¹‹åï¼Œæ”¹å˜æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´ï¼Œä½œä¸ºä¸€ä¸ªå‚è€ƒä¾æ®ã€‚</p>
<p> åœ¨å†™å…¥çš„æ—¶å€™ï¼Œå…ˆå°è¯•å°†æ•°æ®å†™å…¥åˆ°ç£ç›˜ï¼Œç„¶åè¯»å–å†™å…¥çš„æ–‡ä»¶çš„ä¿¡æ¯ï¼Œæ¯”è¾ƒæ–‡ä»¶çš„å¤§å°æ˜¯å¦å’Œå†™å…¥çš„æ•°æ®å¤§å°ç›¸åŒ</p>
<h3 id="å¼‚æ­¥æ“ä½œ"><a href="#å¼‚æ­¥æ“ä½œ" class="headerlink" title="å¼‚æ­¥æ“ä½œ"></a>å¼‚æ­¥æ“ä½œ</h3><p>åœ¨<code>PINDiskCache</code>ä¸­å¤§é‡ä½¿ç”¨äº†å¼‚æ­¥æ“ä½œã€‚æ¯”å¦‚è¯»å–æ–‡ä»¶åä¿®æ”¹æ–‡ä»¶æ—¶é—´ï¼š</p>
<pre><code class="objc">- (void)asynchronouslySetFileModificationDate:(NSDate *)date forURL:(NSURL *)fileURL
{
    __weak PINDiskCache *weakSelf = self;
    [self.operationQueue addOperation:^{
        PINDiskCache *strongSelf = weakSelf;
        if (strongSelf) {
            [strongSelf lock];
                [strongSelf _locked_setFileModificationDate:date forURL:fileURL];
            [strongSelf unlock];
        }
    } withPriority:PINOperationQueuePriorityLow];
}
</code></pre>
<p>è¿™é‡Œç”¨çš„<code>operationQueue</code>å°±æ˜¯åœ¨ä¸‹é¢è¦è®²åˆ°<code>PINCache</code>è‡ªå·±å®ç°çš„ä¸€å¥—å¼‚æ­¥æ–¹æ¡ˆ</p>
<h3 id="æ·˜æ±°æ–¹æ³•"><a href="#æ·˜æ±°æ–¹æ³•" class="headerlink" title="æ·˜æ±°æ–¹æ³•"></a>æ·˜æ±°æ–¹æ³•</h3><p><code>PINDiskCache</code>ä»ç„¶æ ¹æ®æ–‡ä»¶å¤§å°å’Œæœ€è¿‘ä¿®æ”¹æ—¶é—´æ¥ä½œä¸ºæ·˜æ±°çš„ä¾æ®ã€‚</p>
<h2 id="PINOperationQueue"><a href="#PINOperationQueue" class="headerlink" title="PINOperationQueue"></a>PINOperationQueue</h2><p><code>PINOperationQueue</code>æ˜¯<code>PINCache</code>å®ç°çš„ä¸€ä¸ªå¹¶å‘æ§åˆ¶æ–¹æ¡ˆã€‚å®ç°äº†æœ€å¤§å¹¶å‘æ•°ï¼Œå–æ¶ˆï¼Œä¼˜å…ˆçº§ç®¡ç†ã€‚åœ¨<code>PINDiskCache</code>ä¸­å¤§é‡ä½¿ç”¨äº†<code>PINOperationQueue</code>æ¥è¾¾åˆ°å¹¶å‘è¡Œä¸ºçš„æ§åˆ¶ã€‚</p>
<h3 id="å®ç°ç»†èŠ‚-1"><a href="#å®ç°ç»†èŠ‚-1" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h3><p><code>PINOperationQueue</code>æ˜¯å¯¹å¤–å…¬å¼€çš„æ“ä½œï¼Œä¸»è¦æ˜¯é€šè¿‡ä¸‹é¢æ–¹æ³•æ·»åŠ æ“ä½œ</p>
<pre><code class="objc">- (id &lt;PINOperationReference&gt;)addOperation:(PINOperationBlock)operation
                              withPriority:(PINOperationQueuePriority)priority
                                identifier:(NSString *)identifier
                            coalescingData:(nullable id)coalescingData
                      dataCoallescingBlock:(nullable PINOperationDataCoallescingBlock)dataCoallescingBlock
                                completion:(nullable dispatch_block_t)completion;
</code></pre>
<p>å…¶ä¸­<code>dataCoallescingBlock</code>å’Œ<code>coalescingData</code>æä¾›äº†è”åˆæ•°æ®å¤„ç†çš„èƒ½åŠ›ï¼Œä¾‹å¦‚</p>
<pre><code class="objc">- (void)trimToDate:(NSDate *)trimDate block:(PINDiskCacheBlock)block
{
    PINOperationBlock operation = ^(id data){
        [self trimToDate:(NSDate *)data];
    };

    dispatch_block_t completion = nil;
    if (block) {
        completion = ^{
            block(self);
        };
    }

    [self.operationQueue addOperation:operation
                         withPriority:PINOperationQueuePriorityLow
                           identifier:PINDiskCacheOperationIdentifierTrimToDate
                       coalescingData:trimDate
                  dataCoallescingBlock:PINDiskTrimmingDateCoallescingBlock
                           completion:completion];
}
</code></pre>
<p>è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œ<code>DiskCache</code>ä¼šå»æ¸…é™¤æŒ‡å®šæ—¶é—´çš„æ•°æ®ï¼Œåœ¨è¿™é‡Œï¼Œæ·»åŠ åˆ°<code>PINOperationQueue</code>çš„æ—¶å€™ï¼Œå°†<code>trimDate</code>ä½œä¸ºè”åˆæ•°æ®ä¼ å…¥ã€‚è¿™é‡Œçš„è”åˆæ•°æ®ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯blockä¹‹å¤–çš„ä¸€ä¸ªè´Ÿè½½ã€‚</p>
<h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>é€šè¿‡åˆå§‹åŒ–å¯ä»¥å¾—çŸ¥ï¼Œ<code>PINOperationQueue</code>æ˜¯æ€ä¹ˆå®ç°ä¸Šè¿°åŠŸèƒ½çš„ã€‚</p>
<pre><code class="objc"> pthread_mutex_t _lock;
  //increments with every operation to allow cancelation
  NSUInteger _operationReferenceCount;
  NSUInteger _maxConcurrentOperations;

  dispatch_group_t _group;

  dispatch_queue_t _serialQueue;
  BOOL _serialQueueBusy;

  dispatch_semaphore_t _concurrentSemaphore;
  dispatch_queue_t _concurrentQueue;
  dispatch_queue_t _semaphoreQueue;

  NSMutableOrderedSet&lt;PINOperation *&gt; *_queuedOperations;
  NSMutableOrderedSet&lt;PINOperation *&gt; *_lowPriorityOperations;
  NSMutableOrderedSet&lt;PINOperation *&gt; *_defaultPriorityOperations;
  NSMutableOrderedSet&lt;PINOperation *&gt; *_highPriorityOperations;

  NSMapTable&lt;id&lt;PINOperationReference&gt;, PINOperation *&gt; *_referenceToOperations;
  NSMapTable&lt;NSString *, PINOperation *&gt; *_identifierToOperations;
</code></pre>
<p>é€šè¿‡<code>PINOperationQueue</code>çš„æˆå‘˜å˜é‡ï¼Œå¯ä»¥å¾—çŸ¥ï¼š</p>
<ol>
<li>é€šè¿‡<code>dispatch_semaphore_t</code>æ¥å®ç°å¹¶å‘æ•°æ§åˆ¶ã€‚<code>dispatch_semaphore_t</code>æ˜¯ä¿¡å·é‡</li>
<li>é€šè¿‡<code>NSMutableOrderedSet</code>å®ç°äº†ä¼˜å…ˆçº§å’Œé¡ºåºç®¡ç†ã€‚<code>NSMutableOrderedSet</code>æ˜¯å…·æœ‰æ’åºåŠŸèƒ½çš„é›†åˆç±»ã€‚</li>
<li>é€šè¿‡<code>NSMapTable</code>å®ç°äº†ç»‘å®šidå’Œæ“ä½œã€‚<code>NSMapTable</code>ç±»ä¼¼<code>NSdictionry</code>ï¼ŒåŒºåˆ«åœ¨äº<code>NSMapTable</code>æ˜¯å¯å˜çš„ï¼ŒåŒæ—¶é”®å€¼å¯ä»¥ä¸ºå¼±å¼•ç”¨ï¼Œå½“ä»»ä½•ä¸€é¡¹ä¸ºnilçš„æ—¶å€™å°†è¿™ä¸€é¡¹ç§»é™¤ã€‚åŒæ—¶ï¼Œ<code>NSMapTable</code>å¯ä»¥å­˜å‚¨ä»»æ„æŒ‡é’ˆï¼Œé€šè¿‡æŒ‡é’ˆæ¥è¿›è¡Œç›¸ç­‰æ€§å’Œæ•£åˆ—æ ¡éªŒ</li>
</ol>
<p>åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="objc">- (instancetype)initWithMaxConcurrentOperations:(NSUInteger)maxConcurrentOperations concurrentQueue:(dispatch_queue_t)concurrentQueue
{
  if (self = [super init]) {
    NSAssert(maxConcurrentOperations &gt; 1, @&quot;Max concurrent operations must be greater than 1. If it&#39;s one, just use a serial queue!&quot;);
    _maxConcurrentOperations = maxConcurrentOperations;
    _operationReferenceCount = 0;

    pthread_mutexattr_t attr;
    pthread_mutexattr_init(&amp;attr);
    //mutex must be recursive to allow scheduling of operations from within operations
    pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_RECURSIVE);
    pthread_mutex_init(&amp;_lock, &amp;attr);

    _group = dispatch_group_create();

    _serialQueue = dispatch_queue_create(&quot;PINOperationQueue Serial Queue&quot;, DISPATCH_QUEUE_SERIAL);

    _concurrentQueue = concurrentQueue;

    //Create a queue with max - 1 because this plus the serial queue add up to max.
    _concurrentSemaphore = dispatch_semaphore_create(_maxConcurrentOperations - 1);
    _semaphoreQueue = dispatch_queue_create(&quot;PINOperationQueue Serial Semaphore Queue&quot;, DISPATCH_QUEUE_SERIAL);

    _queuedOperations = [[NSMutableOrderedSet alloc] init];
    _lowPriorityOperations = [[NSMutableOrderedSet alloc] init];
    _defaultPriorityOperations = [[NSMutableOrderedSet alloc] init];
    _highPriorityOperations = [[NSMutableOrderedSet alloc] init];

    _referenceToOperations = [NSMapTable weakToWeakObjectsMapTable];
    _identifierToOperations = [NSMapTable weakToWeakObjectsMapTable];
  }
  return self;
}
</code></pre>
<p>åœ¨è¿™é‡Œï¼Œå®ç°äº†ä¸€ä¸ªé€’å½’é”ã€‚é€’å½’é”å…è®¸åœ¨æœªé‡Šæ”¾é”çš„æ—¶å€™åå¤çš„ä¸Šé”ï¼Œå½“è§£é”æ¬¡æ•°å’Œç­‰äºä¸Šé”çš„æ¬¡æ•°çš„æ—¶å€™æ‰<code>PINOperationQueue</code>å¯èƒ½åœ¨ä¸€ä¸ªå¤šæ¬¡åŠ é”ã€‚</p>
<h4 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h4><p><code>PINOperationQueue</code>æœ€å¤§ç‰¹è‰²å°±æ˜¯å®ç°äº†å¹¶å‘ç®¡ç†æ“ä½œï¼Œæä¾›cancelï¼Œwait, Priorityçš„åŠŸèƒ½ï¼Œé€šè¿‡å®ç°æ¥çœ‹çœ‹æ€ä¹ˆåšåˆ°çš„ã€‚</p>
<p><code>- (void)scheduleNextOperations:(BOOL)onlyCheckSerial</code>æ–¹æ³•ä¸ºæ´¾å‘operationçš„åœ°æ–¹ç§æœ‰æ–¹æ³•ã€‚</p>
<p><code>scheduleNextOperations</code>æ‰§è¡Œçš„åˆ†ä¸ºä¸¤å—</p>
<pre><code class="objc">  [self lock];
    //get next available operation in order, ignoring priority and run it on the serial queue
    if (_serialQueueBusy == NO) {
      PINOperation *operation = [self locked_nextOperationByQueue];
      if (operation) {
        _serialQueueBusy = YES;
        dispatch_async(_serialQueue, ^{
          operation.block(operation.data);
          for (dispatch_block_t completion in operation.completions) {
            completion();
          }
          dispatch_group_leave(_group);

          [self lock];
            _serialQueueBusy = NO;
          [self unlock];

          //see if there are any other operations
          [self scheduleNextOperations:YES];
        });
      }
    }
  [self unlock];
</code></pre>
<p>åœ¨è¿™é‡Œï¼Œ<code>locked_nextOperationByQueue</code>ä»<code>_queuedOperations</code>å–å‡ºç¬¬ä¸€ä¸ªoperationï¼Œç„¶åå¼‚æ­¥æ´¾å‘åˆ°<code>_serialQueue</code>ä¸­æ‰§è¡Œã€‚å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œæœ¬è´¨æ˜¯ä¸²è¡Œå–å‡ºoperationç„¶åå†æ´¾å‘åˆ°<code>_serialQueue</code>å¼‚æ­¥æ‰§è¡Œã€‚</p>
<pre><code class="objc">  dispatch_async(_semaphoreQueue, ^{
      dispatch_semaphore_wait(_concurrentSemaphore, DISPATCH_TIME_FOREVER);
      [self lock];
        PINOperation *operation = [self locked_nextOperationByPriority];
      [self unlock];

      if (operation) {
        dispatch_async(_concurrentQueue, ^{
          operation.block(operation.data);
          for (dispatch_block_t completion in operation.completions) {
            completion();
          }
          dispatch_group_leave(_group);
          dispatch_semaphore_signal(_concurrentSemaphore);
        });
      } else {
        dispatch_semaphore_signal(_concurrentSemaphore);
      }
  });
</code></pre>
<p>åœ¨è¿™é‡Œï¼Œå®ç°äº†å¹¶å‘ï¼Œä»<code>locked_nextOperationByPriority</code>æ–¹æ³•ä¸­æ ¹æ®ä¼˜å…ˆçº§è·å¾—ä¸€ä¸ªoperationï¼Œå¼‚æ­¥æ´¾å‘åˆ°<code>_concurrentQueue</code>ä¸­æ‰§è¡Œã€‚è¿™é‡Œé€šè¿‡ä¿¡å·é‡æ¥ç®¡ç†å¹¶å‘æ•°ï¼Œå½“ä¿¡å·é‡ä¸º0çš„æ—¶å€™å°±ä¼šä¸€ç›´ç­‰å¾…ã€‚</p>
<p><code>locked_nextOperationByPriority</code>ä¸­ä»<code>_highPriorityOperations</code>å–ï¼Œå–ä¸åˆ°çš„æƒ…å†µä¸‹å°±ä»ä¸‹ä¸€ä¸ªä¼˜å…ˆçº§çš„setä¸­å–ã€‚</p>
<p>çœ‹æ‡‚äº†<code>scheduleNextOperations</code>ï¼Œå†çœ‹<code>locked_cancelOperation</code>å°±ä¸éš¾äº†ã€‚</p>
<pre><code class="objc">- (BOOL)locked_cancelOperation:(id &lt;PINOperationReference&gt;)operationReference
{
  BOOL success = NO;
  PINOperation *operation = [_referenceToOperations objectForKey:operationReference];
  if (operation) {
    NSMutableOrderedSet *queue = [self operationQueueWithPriority:operation.priority];
    if ([queue containsObject:operation]) {
      success = YES;
      [queue removeObject:operation];
      [_queuedOperations removeObject:operation];
      dispatch_group_leave(_group);
    }
  }
  return success;
}
</code></pre>
<p>å–æ¶ˆæ“ä½œï¼Œä¸»è¦æ ¹æ®operationRefæ¥å–å‡ºæ“ä½œï¼Œç„¶åä»æ‰€åœ¨çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­åˆ é™¤å¯¹åº”çš„operationã€‚æ³¨æ„åˆ°ï¼Œå¦‚æœè¿™ä¸ªoperationå·²ç»è¢«æ´¾å‘åˆ°æ‰§è¡Œé˜Ÿåˆ—ä¸Šäº†ï¼Œå°±æ— æ³•å–æ¶ˆäº†ã€‚</p>
<p><code>PINOperationGroup</code>æ˜¯åœ¨<code>PINOperationQueue</code>ä¹‹ä¸Šå†å®ç°çš„åŒ…è£…ã€‚</p>
<p><code>PINOperationQueue</code>å’Œ<code>PINOperationGroup</code>å¯ä»¥çœ‹åšæ˜¯<code>PINCache</code>ä½¿ç”¨çš„GCDå®ç°ä¸€å¥—ä¸NSOperationç›¸ä¼¼çš„åŠŸèƒ½ã€‚é€šè¿‡å­¦ä¹ é˜…è¯»è¿™ä¸€å—ï¼Œå¯ä»¥åŠ æ·±å¯¹GCDå¼‚æ­¥å¤„ç†çš„ç†è§£ã€‚</p>
<h2 id="å°¾å£°"><a href="#å°¾å£°" class="headerlink" title="å°¾å£°"></a>å°¾å£°</h2><p><code>PINCache</code>æ˜¯è¿™ä¸ªç³»åˆ—çš„ç¬¬äºŒç¯‡ï¼Œä¸ªäººæ„Ÿè§‰æ”¶è·å¾ˆå¤§ï¼Œå¯¹æ•´ä¸ªkey-valueç¼“å­˜å®ç°çš„ä¸€ä¸ªæ€è·¯æœ‰äº†æ›´æ¸…æ¥šçš„è®¤è¯†ã€‚</p>
<p>ä¸‹ä¸€ç¯‡ï¼Œæ‰“ç®—çœ‹çœ‹<code>YYCache</code>,ä¸»è¦å…³æ³¨ç‚¹æ˜¯å¦‚ä½•å®ç°ç¼“å­˜æ·˜æ±°ç®—æ³•å’Œä¼˜åŒ–æ€§èƒ½çš„ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://csbzhixing.github.io/2017/01/08/æŒä¹…åŒ–å­¦ä¹ ç³»åˆ—1/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="csbzhixing">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://p3.pstatp.com/large/ab000310321818ab99.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="å­¦æµ·æ— æ¶¯">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="å­¦æµ·æ— æ¶¯" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/08/æŒä¹…åŒ–å­¦ä¹ ç³»åˆ—1/" itemprop="url">
                  æŒä¹…åŒ–å­¦ä¹ ç³»åˆ—1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-08T16:16:57+08:00">
                2017-01-08
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>SPTPersistentCache</code>æ˜¯<strong>spotify</strong>å¼€æºçš„ä¸€å¥—æŒä¹…åŒ–æ¡†æ¶ã€‚<code>SPTPersistentCache</code>ä¸»è¦è§£å†³<code>NSData</code>å­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿçš„è¿‡ç¨‹ã€‚</p>
<h2 id="äº®ç‚¹"><a href="#äº®ç‚¹" class="headerlink" title="äº®ç‚¹"></a>äº®ç‚¹</h2><ul>
<li>åŸºäºLRU</li>
<li>çº¿ç¨‹å®‰å…¨</li>
<li>å¯è§†åŒ–å·¥å…·</li>
<li>ç±»HTTPè®¾è®¡</li>
</ul>
<h2 id="æˆå‘˜åˆ†æ"><a href="#æˆå‘˜åˆ†æ" class="headerlink" title="æˆå‘˜åˆ†æ"></a>æˆå‘˜åˆ†æ</h2><p>å…ˆä»Public Apiæ¥è¿›è¡Œåˆ†æ</p>
<p><img src="../media/14824843501540.jpg" alt=""></p>
<p><code>SPTPersistentCache</code>æ˜¯æ ¸å¿ƒï¼ŒåŒæ¯”ä¸ºmanagerçš„è§’è‰²ã€‚<br><code>SPTPersistentCacheOptions</code>æ˜¯é…ç½®é€‰é¡¹ï¼Œ<br><code>SPTPersistentCacheHeader</code>æ˜¯<code>SPTPersistentCache</code>çš„ä¸€å¤§è®¾è®¡çš„ç‰¹è‰²ï¼Œæ•°æ®è¡¨å¤´<br><code>SPTPersistentCacheRecord</code>ä¸ºæ•°æ®å•å…ƒã€‚<br><code>SPTPersistentCacheResponse</code>ä¸ºæ“çºµæ•°æ®çš„åŸºæœ¬å•ä½ã€‚</p>
<p>è¿™æ¬¡åˆ†ææ‰“ç®—ä»ä¸‹å¾€ä¸Šï¼Œå…ˆä»åŸºæœ¬çš„æ•°æ®å•å…ƒå¼€å§‹</p>
<h3 id="SPTPersistentCacheRecord"><a href="#SPTPersistentCacheRecord" class="headerlink" title="SPTPersistentCacheRecord"></a>SPTPersistentCacheRecord</h3><p><code>SPTPersistentCacheRecord</code>ä¸­é™¤äº†dataä¹‹å¤–è¿˜å®šä¹‰ä¸‰ä¸ªè¾…åŠ©æ•°æ®</p>
<ul>
<li>refCount å¼•ç”¨è®¡æ•°</li>
<li>ttl ç”Ÿå­˜æ—¶é—´</li>
<li>key </li>
</ul>
<p>å¯ä»¥ä»<code>SPTPersistentCacheRecord</code>çœ‹å‡º<code>SPTPersistent</code>ä¾ç…§å¼•ç”¨æ¬¡æ•°å’Œæ—¶é—´æ¥ç®¡ç†ç¼“å­˜å¯¹è±¡</p>
<h3 id="SPTPersistentCacheResponse"><a href="#SPTPersistentCacheResponse" class="headerlink" title="SPTPersistentCacheResponse"></a>SPTPersistentCacheResponse</h3><p><code>SPTPersistentCacheResponse</code>æ˜¯å¯¹<code>SPTPersistentCacheRecord</code>çš„å†ä¸€å±‚åŒ…è£…ã€‚æ–°å¢äº†å¯¹å¤–å±æ€§</p>
<ul>
<li>SPTPersistentCacheResponseCode</li>
<li>NSError</li>
</ul>
<p>ä»<code>SPTPersistentCacheResponseCode</code>å¯ä»¥çœ‹å‡ºè¿™ä¸€å±‚ä¸è¯»å†™æ“ä½œç›¸å…³äº†ã€‚</p>
<h3 id="SPTPersistentCacheRecord-1"><a href="#SPTPersistentCacheRecord-1" class="headerlink" title="SPTPersistentCacheRecord"></a>SPTPersistentCacheRecord</h3><p><code>SPTPersistentCacheRecord</code>å¹¶ä¸æ˜¯ä¸€ä¸ªç±»ï¼Œè€Œæ˜¯ä¸€ä¸ªç»“æ„ä½“ã€‚åœ¨è¿™é‡Œï¼Œå¯ä»¥å°†<code>SPTPersistentCacheRecord</code>ä¸HTTPä¸­çš„<code>header</code>è¿›è¡Œç±»æ¯”ã€‚</p>
<p>å…³é”®ç‚¹ï¼šcrcï¼Œflags</p>
<p>crcï¼š<strong>å¾ªç¯å†—ä½™æ ¡éªŒ</strong> åœ¨æ•°æ®å†™å…¥å‰é€šè¿‡è®¡ç®—ç”Ÿæˆ32ä½æ•´æ•°ï¼Œæ‹¼æ¥åœ¨æ•°æ®åé¢ã€‚åœ¨è¯»å–çš„æ—¶å€™è¿›è¡Œæ ¡éªŒï¼Œç¡®è®¤æ•°æ®æ˜¯å¦å®Œæ•´ã€‚<code>SPTPersistentCache</code>ä½¿ç”¨çš„æ˜¯<code>CRC-64-ISO</code></p>
<p>flags: åˆ¤æ–­æ•°æ®æ˜¯å¦åœ¨ä¸Šæ¬¡å†™å…¥çš„æ—¶å€™æ²¡èƒ½å®Œæˆã€‚è¿™ä¸ªæ›´å¤šæ˜¯é€»è¾‘è€Œä¸æ˜¯ä¸€ä¸ªé”™è¯¯ã€‚</p>
<h3 id="SPTPersistentCacheOptions"><a href="#SPTPersistentCacheOptions" class="headerlink" title="SPTPersistentCacheOptions"></a>SPTPersistentCacheOptions</h3><p><code>SPTPersistentCacheOptions</code>æ˜¯cacheçš„é…ç½®ç›¸å…³çš„å†…å®¹ã€‚ä»é…ç½®ä¸­å¤Ÿå¯ä»¥çœ‹å‡º<code>SPTPersistentCache</code>çš„ä¸€äº›ç‰¹æ€§</p>
<p><code>identifierForQueue</code>ä½œä¸ºå”¯ä¸€é˜Ÿåˆ—æ ‡è¯†ï¼Œå¯ä»¥é¢„çŸ¥æ¯ä¸€ä¸ªcacheæ‹¥æœ‰å”¯ä¸€çš„é˜Ÿåˆ—</p>
<p><code>cacheIdentifier</code>ä½œä¸ºé…ç½®å¯¹åº”çš„cacheå”¯ä¸€æ ‡è¯†</p>
<p>ä¼˜å…ˆçº§è®¾å®šä¸­åˆ†åˆ«å®šä¹‰äº†å¹¶å‘æ“ä½œæ•°ï¼Œè¯»å†™åˆ çš„ä¼˜å…ˆçº§</p>
<pre><code class="objc">@property (nonatomic) NSInteger maxConcurrentOperations;
@property (nonatomic) NSOperationQueuePriority writePriority;
@property (nonatomic) NSOperationQueuePriority readPriority;
@property (nonatomic) NSOperationQueuePriority deletePriority;
@property (nonatomic) NSQualityOfService writeQualityOfService;
@property (nonatomic) NSQualityOfService readQualityOfService;
@property (nonatomic) NSQualityOfService deleteQualityOfService;
</code></pre>
<p>GCè®¾å®šä¸­å¯¹GCçš„é…ç½®è¿›è¡Œè®¾å®š</p>
<p><code>garbageCollectionInterval</code>å†³å®šäº†GCçš„é—´éš”</p>
<p><code>defaultExpirationPeriod</code> å†³å®šé»˜è®¤è¿‡æœŸæ—¶é—´</p>
<p><code>sizeConstraintBytes</code> è®¾å®šäº†ç¼“å­˜ç©ºé—´çš„é™åˆ¶</p>
<p><code>garbageCollectionPriority</code>è®¾å®šGCæ“ä½œçš„ä¼˜å…ˆçº§</p>
<p><code>garbageCollectionQualityOfService</code>è®¾å®šGCæœåŠ¡çš„QOS</p>
<p>ä»optionä¸­å¯ä»¥çª¥æ¢å‡ºï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯èƒ½ä¼šæœ‰å¤šä¸ªcacheï¼Œæ¯ä¸ªcacheä¹‹é—´çš„é…ç½®ç‹¬ç«‹ï¼Œæ‹¥æœ‰ç‹¬ç«‹çš„ä¼˜å…ˆçº§å’ŒGCç®¡ç†</p>
<h3 id="SPTPersistentCache"><a href="#SPTPersistentCache" class="headerlink" title="SPTPersistentCache"></a>SPTPersistentCache</h3><p><code>SPTPersistentCache</code>æ˜¯æ•´ä¸ªæŒä¹…åŒ–åº“çš„æ ¸å¿ƒç±»ï¼ŒåŒ…å«äº†è¯»ï¼Œå†™ï¼ŒæŸ¥ï¼Œåˆ ï¼Œé”ç­‰æ“ä½œ</p>
<p>è¯»æ“ä½œä¸­ï¼Œå¯¹å¤–å…¬å¼€çš„ä¸¤ä¸ªAPIæœ€åä¼šå½’é›†åˆ°ä¸‹é¢è¿™ä¸ªæ–¹æ³•ä¸­</p>
<pre><code class="objc">- (void)loadDataForKeySync:(NSString *)key
              withCallback:(SPTPersistentCacheResponseCallback)callback
                   onQueue:(dispatch_queue_t)queue
</code></pre>
<p>æ–¹æ³•å¹¶ä¸æ˜¯å¾ˆå¤æ‚ï¼Œå…·ä½“çš„æµç¨‹ç®€å•æè¿°å¦‚ä¸‹</p>
<pre><code>é¦–å…ˆï¼Œæ ¹æ®keyå»æŸ¥æ‰¾æ˜¯å¦æœ‰å¯¹åº”çš„æ–‡ä»¶ï¼Œæœ¨æœ‰çš„è¯å°±æŠ›é”™ (1)

å¦‚æœæ‰¾åˆ°äº†æ–‡ä»¶ï¼Œè¯»å–dataï¼Œå¦‚æœè¯»å–å¤±è´¥ï¼Œè®¤ä¸ºæ–‡ä»¶æŸåäº†ï¼ŒæŠ›é”™(2)

ä»æ–‡ä»¶ä¸­è¯»å‡ºäº†æ•°æ®ï¼Œæ ¹æ®headerSizeå–å‡ºheadã€‚å¦‚æœä¸èƒ½æ­£ç¡®çš„æ‹¼è£…å‡ºheaderï¼Œå³è®¤ä¸ºæ­¤æ–‡ä»¶æ— æ³•ç»§ç»­æ“ä½œï¼ŒæŠ›é”™(3)

æ‹¼è£…äº†headeråï¼Œè¿›è¡Œæ ¡éªŒï¼Œæ ¡éªŒä¸é€šè¿‡ï¼ŒæŠ›é”™(4)

ä¸æœ¬åœ°headeråšæ¯”è¾ƒï¼Œå¦‚æœä¸ä¸€è‡´ï¼ŒæŠ›é”™(5)

å°†è¯»å‡ºçš„payload(è´Ÿè½½æ•°æ®)ç»„è£…æˆ`SPTPersistentCacheRecord`ï¼Œå†å°†`SPTPersistentCacheRecord`ç»„è£…æˆ`SPTPersistentCacheResponse`

å°†è®¿é—®æ•°æ®ç›¸å…³å†™å›ç£ç›˜

å°†responseé€šè¿‡blockå›è°ƒç»™å¼€å‘è€…ã€‚
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæ€»å…±æœ‰5æ­¥æŠ›é”™çš„åœ°æ–¹ï¼Œéƒ½æ˜¯å¯¹æ•°æ®å®Œæ•´æ€§çš„æ ¡éªŒã€‚</p>
<p>ç›¸å¯¹äºè¯»ï¼Œå†™çš„éš¾åº¦å°±å°äº†å¾ˆå¤šï¼Œä¸å¤ªå¤æ‚ã€‚å†™æ–¹æ³•ä¸»è¦æ˜¯åœ¨</p>
<pre><code class="objc">- (NSError *)storeDataSync:(NSData *)data
                    forKey:(NSString *)key
                       ttl:(NSUInteger)ttl
                    locked:(BOOL)isLocked
              withCallback:(SPTPersistentCacheResponseCallback)callback
                   onQueue:(dispatch_queue_t)queue
</code></pre>
<p>å°†Headerä¸dataæ‹¼è£…åç»„æˆrowDataï¼Œç„¶åå†™å…¥ç£ç›˜ï¼Œæ³¨æ„åˆ¤æ–­æ˜¯å¦å†™å…¥æˆåŠŸã€‚ä¹‹åé€šè¿‡blockå°†responseå›è°ƒç»™å¼€å‘è€…</p>
<h2 id="GCå’ŒLRUå®ç°"><a href="#GCå’ŒLRUå®ç°" class="headerlink" title="GCå’ŒLRUå®ç°"></a>GCå’ŒLRUå®ç°</h2><p><strong>LRUæ˜¯Least Recently Used è¿‘æœŸæœ€å°‘ä½¿ç”¨ç®—æ³•ã€‚</strong></p>
<p>åœ¨æœ€è¿‘çš„é¢è¯•ä¸­ï¼Œç»å¸¸ä¼šè°ˆåˆ°ä¸€äº›ç¼“å­˜åº“çš„å®ç°ï¼Œæ¯”å¦‚æœ€å¸¸è§çš„<code>SDWebImageCache</code>ã€‚å¯¹æ­¤æˆ‘å¸¸ä¼šæå‡ºä¸€ä¸ªç–‘é—®ï¼Œå¦‚ä½•è®¾è®¡é«˜æ•ˆçš„ç¼“å­˜ã€‚å‡ ä¹æ²¡äººèƒ½å¤Ÿè°ˆè°ˆç¼“å­˜è°ƒåº¦ç®—æ³•ã€‚LRUå…¶å®å°±æ˜¯æœ€å¸¸ç”¨çš„ä¸€ç§ç¼“å­˜è°ƒåº¦ç®—æ³•ï¼Œç›®çš„å°±æ˜¯å°½åŠ›ä¿è¯ç¼“å­˜ä¸­çš„æ•°æ®æ˜¯å¸¸ç”¨çš„ã€‚</p>
<p>è¿™é‡Œè°ˆè°ˆ<code>SPTPersistentCache</code>ä¸­æ˜¯å¦‚ä½•å®ç°GCå’ŒLRUç®—æ³•çš„ã€‚</p>
<p>åœ¨ä¸Šæ–‡<code>SPTPersistentCacheRecord</code>çš„ç®€ä»‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸¤ä¸ªå…³é”®çš„å±æ€§ï¼šTTL &amp;&amp; refcountã€‚æˆ‘ä»¬å¯ä»¥çŒœæµ‹åˆ°ï¼Œ<code>SPTPersistentCache</code>æ˜¯é€šè¿‡å®è·µå’Œå¼•ç”¨å€¼æ¥åˆ¤æ–­æ˜¯æ•°æ®çš„æœ‰æ•ˆæ€§çš„ã€‚</p>
<p>GCçš„æ ¸å¿ƒæ˜¯ğŸ‘‡è¿™ä¸ªæ–¹æ³•</p>
<pre><code class="objc">- (void)collectGarbageForceExpire:(BOOL)forceExpire forceLocked:(BOOL)forceLocked
</code></pre>
<p>ä¼ å‚åˆ†åˆ«æ˜¯å¼ºåˆ¶è¿‡æœŸå’Œå¼ºåˆ¶åŠ é”ã€‚</p>
<p>è¿‡ç¨‹ä¸å¤æ‚ï¼Œé€šè¿‡<code>NSDirectoryEnumerator</code>è¿­ä»£å™¨ä»<code>self.fileManager</code>ä¸­å–å‡ºæ‰€æœ‰æ–‡ä»¶ã€‚</p>
<p>åˆ¤æ–­æ˜¯å¦è¿‡æœŸæ˜¯é€šè¿‡ä¸‹é¢è¿™ä¸ªæ–¹æ³•</p>
<pre><code class="objc">- (SPTPersistentCacheResponse *)alterHeaderForFileAtPath:(NSString *)filePath
                                               withBlock:(SPTPersistentCacheRecordHeaderGetCallbackType)modifyBlock
                                               writeBack:(BOOL)needWriteBack
                                                complain:(BOOL)needComplains
</code></pre>
<p>è¿™ä¸ªæ–¹æ³•æ˜¯å”¯ä¸€å»è®¿é—®æ–‡ä»¶headerçš„æ–¹æ³•ã€‚</p>
<p>ä¼ å…¥<code>modifyBlock</code>å°†æ”¹å˜headerã€‚</p>
<p>å›åˆ°GCçš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ°é€šè¿‡ä¼ å…¥<code>modifyBlock</code>æ¥è·å–headerã€‚åœ¨<code>modifyBlock</code>ä¸­ï¼Œé€šè¿‡headerä¸­çš„refcountæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»é™¤ã€‚</p>
<p>é‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¼šè§¦å‘<code>refcount</code>çš„å˜åŒ–å‘¢ï¼Ÿ</p>
<p>åœ¨<code>lockDataForKeys</code>æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ ·ä¸€è¡Œä»£ç </p>
<pre><code class="objc"> // Satisfy Req.#1.2
 if ([self isDataExpiredWithHeader:header]) {
 expired = YES;
 return;                                                                        }
++header-&gt;refCount;
// Do not update access time since file is locked
</code></pre>
<p>å¯çŸ¥ï¼Œå½“æ‰§è¡Œlockçš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®æœ¬èº«æ²¡è¿‡æœŸï¼Œä¼šä½¿å¼•ç”¨è®¡æ•°+1ã€‚</p>
<p>åŒç†ï¼Œå½“unlockçš„æ—¶å€™ï¼Œä¼šä½¿å¼•ç”¨è®¡æ•°-1ã€‚</p>
<p>å¯è§ï¼Œrefcountåªæœ‰1å’Œ0ä¸¤ä¸ªå€¼ã€‚</p>
<p>è€Œ<code>TTLï¼ˆå­˜æ´»æ—¶é—´ï¼‰</code>åˆ™æ˜¯æ•°æ®çš„çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœæ²¡æœ‰<code>forceExpire</code>å’Œ<code>forceLocked</code>çš„è¯ï¼Œåˆ™å½“<code>[self isDataExpiredWithHeader:header] &amp;&amp; header-&gt;refCount == 0</code>çš„æ—¶å€™åˆ é™¤æ•°æ®ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>githubä¸Šå®ç°äºŒè¿›åˆ¶ç¼“å­˜çš„cacheåº“ä¸å¤šï¼Œ<code>SPTPersistentCache</code>æ˜¯å…¶ä¸­çš„ä½¼ä½¼è€…ã€‚åŸå› åœ¨äº<strong>spotify</strong>æœ¬èº«åšåœ¨çº¿éŸ³ä¹æœåŠ¡ï¼Œåœ¨äºŒè¿›åˆ¶ç¼“å­˜ä¸Šæœ‰æ¯”è¾ƒå¼ºçš„éœ€æ±‚ã€‚</p>
<p><code>SPTPersistentCache</code>çš„å®ç°æˆ‘è®¤ä¸ºå‚è€ƒäº†HTTPåè®®ï¼Œé€šè¿‡ä¸€ä¸ªHeaderæ¥ä¸ºæ•°æ®æ·»åŠ metedataï¼ŒåŒæ—¶å®ç°äº†GCã€‚å¯ä»¥<code>SPTPersistentCache</code>çš„å®ç°æ–¹å¼éå¸¸å€¼å¾—å­¦ä¹ ï¼Œåœ¨é˜…è¯»<code>SPTPersistentCache</code>çš„è¿‡ç¨‹ä¸­å­¦ä¹ äº†ä¸å°‘äºŒè¿›åˆ¶æ–‡ä»¶æ“ä½œçš„æ–¹æ³•ï¼Œæ”¶ç›Šè‰¯å¤šï¼Œä¹Ÿä¸ºè¿™ä¸ªç³»åˆ—å¼€äº†ä¸€ä¸ªå¥½å¤´ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://csbzhixing.github.io/2016/12/31/2016ï¼Œæ³¨å®šä¸å¹³å‡¡/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="csbzhixing">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://p3.pstatp.com/large/ab000310321818ab99.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="å­¦æµ·æ— æ¶¯">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="å­¦æµ·æ— æ¶¯" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/2016ï¼Œæ³¨å®šä¸å¹³å‡¡/" itemprop="url">
                  2016ï¼Œæ³¨å®šä¸å¹³å‡¡
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-31T09:50:41+08:00">
                2016-12-31
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>2016å¹´ï¼Œæ³¨å®šæ˜¯ä¸€ä¸ªä¸ä¸€æ ·çš„å¹´ä»½ã€‚å¹´å¤´åˆ°å¹´å°¾ï¼Œä¸–ç•Œä¸Šå‘ç”Ÿäº†å¤ªå¤šå†å²æ€§çš„è¿›ç¨‹ã€‚ä¸€ä¸ªè‹±å›½è„±æ¬§ï¼Œä¸€ä¸ªç‰¹æœ—æ™®å½“é€‰å°±è¶³ä»¥è®©ä¸–äººè°ˆè®ºä¸Šè®¸å¤šå¹´ã€‚å¯¹äºæˆ‘ä¸ªäººï¼Œä¹Ÿæ˜¯ä¸€ä¸ªä¸åŒå¯»å¸¸çš„å¹´ä»½ï¼šä»Šå¹´æˆ‘æ¯•ä¸šäº†ã€‚</p>
<h3 id="æ¯•ä¸šäº†ï¼Œæˆ‘æƒ³è°ˆè°ˆæ•™è‚²"><a href="#æ¯•ä¸šäº†ï¼Œæˆ‘æƒ³è°ˆè°ˆæ•™è‚²" class="headerlink" title="æ¯•ä¸šäº†ï¼Œæˆ‘æƒ³è°ˆè°ˆæ•™è‚²"></a>æ¯•ä¸šäº†ï¼Œæˆ‘æƒ³è°ˆè°ˆæ•™è‚²</h3><p>ä»ä¸Šå­¦ç¬¬ä¸€å¤©å¼€å§‹ï¼Œæˆ‘å°±æƒ³ä»€ä¹ˆæ—¶å€™ä¼šç»“æŸè¿™ä¸€æ®µå†ç¨‹ï¼Œæƒ³ä¸åˆ°åˆ°æ¥åå´ä¸€ç‚¹æ„Ÿè§‰æ²¡æœ‰ã€‚ç»“æŸäº†å­¦ç”Ÿèº«ä»½ï¼Œæœ€å¤§çš„æ„Ÿè§¦å°±æ˜¯ï¼šä¸å†ä¼šæœ‰äººç…§é¡¾ä½ äº†ã€‚</p>
<p>16å¹´çš„æ±‚å­¦ç»å†ï¼Œæ”¹å˜äº†ä¸€ä¸ªäººå¤šå°‘ï¼Œæ¯ä¸ªäººéƒ½ä¼šæœ‰è‡ªå·±çš„çœ‹æ³•ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œå­¦ç”Ÿæ—¶ä»£å…»æˆçš„ä¹ æƒ¯æ˜¯æ°¸è¿œæ”¹ä¸æ‰çš„ã€‚å¾ˆå¹¸è¿çš„æ˜¯ï¼Œè‡ªå·±èƒ½å¤Ÿä»å°å­¦ä¸€è·¯é¡ºåˆ©å¾—è¯»å®Œå¤§å­¦ã€‚ç›¸æ¯”è¾ƒè®¸å¤šæ— ç¼˜èƒ½å¤Ÿè¿›å…¥å­¦æ ¡å­¦ä¹ çš„äººæ¥è¯´ï¼Œèƒ½å¤Ÿæ¥å—å®Œæ•´ç³»ç»Ÿçš„çŸ¥è¯†æ•™è‚²ï¼Œæ˜¯ä¸€ä»¶å¤ªå¹¸ç¦çš„äº‹æƒ…ã€‚</p>
<p>åœ¨ç»å†äº†å®Œæ•´çš„ä¸­å›½æ•™è‚²ç³»ç»Ÿè®¾è®¡çš„æ•™è‚²ä½“ç³»åï¼Œæ„Ÿè§‰å¹¶æ²¡æœ‰ç½‘ç»œä»¥åŠä»–äººæ‰€è¯´çš„é‚£ä¹ˆä¸å ªã€‚çš„ç¡®ï¼Œä¸­å›½æŸäº›ä½“ç³»åŸå› é€ æˆäº†æ•™è‚²ç³»ç»Ÿå¤šå˜çš„æƒ…å†µï¼Œæˆ‘ä¹Ÿæ˜¯å‡ ä¹è¸å‡†äº†æ¯æ¬¡æ•™è‚²æ”¹é©çš„é—¨æ§›ã€‚ä½†æ˜¯æˆ‘å¹¶ä¸è®¤ä¸ºï¼Œè¿™äº›æ”¹é©æœ€åæ”¹å˜äº†ä»€ä¹ˆï¼Œç”šè‡³æˆ‘ä¸è®¤ä¸ºæ•™æˆçš„å†…å®¹ä¼šå¯¹äººæœ‰ä»€ä¹ˆå½±å“ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘è®¤ä¸ºï¼Œå­¦æ ¡æ•™è‚²å¸¦ç»™æˆ‘æœ€å¤§çš„å¥½å¤„ï¼Œå°±æ˜¯å­¦ä¼šç³»ç»Ÿé€»è¾‘çš„æ€è€ƒä»¥åŠè‡ªå­¦èƒ½åŠ›ã€‚</p>
<p>å¤§å¤šäººæ‰¹åˆ¤ä¸­å›½æ•™è‚²ä¸ºå¡«é¸­å¼æ•™è‚²ã€‚å…¶å®ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œè¿™åªæ˜¯ä¸€ç§è¿«ä¸å¾—å·²çš„æ‰‹æ®µã€‚åªæœ‰åœ¨ä¸¥é…·çš„è®­ç»ƒä¸‹ï¼Œæ‰æœ‰æ‚Ÿçš„å¯èƒ½ã€‚ç»ä¸åŒäºç½‘ç»œå°è¯´çš„ä¸»äººå…¬ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨ä¸€å¤©çªç„¶çµå…‰ä¸€é—ªç„¶åæ‰“é€šäº†ä»»ç£äºŒè„‰å› æ­¤å­¦è´¯ä¸­è¥¿ã€‚æˆ‘ä»¬åªèƒ½åœ¨ä¸åœåœ°æ®‹é…·çš„è®­ç»ƒä¸­æ€»ç»“ï¼Œç›´åˆ°æœ‰ä¸€å¤©æ˜ç™½çŸ¥è¯†çš„ç›¸é€šæ€§ã€‚å¾ˆé—æ†¾çš„æ˜¯ï¼Œå¤ªå¤šäººéº»æœ¨åœ¨é‡å¤é«˜å¼ºåº¦çš„è®­ç»ƒä¸­ï¼Œåªæœ‰å°‘æ•°äººèƒ½å¤Ÿå‚é€ã€‚æˆ‘ä¹Ÿæ˜¯åœ¨å¤§å­¦æœ€åï¼Œæ‰æ˜ç™½è¿‡æ¥ï¼Œä¸ºæ—¶å·²æ™šã€‚</p>
<p>æ•™è‚²ï¼Œæœ€å¤§çš„ç›®çš„æ˜¯æˆäººä»¥æ¸”ã€‚å­¦ä¼šå­¦ä¹ æ‰æ˜¯å­¦ä¹ æœ€å¤§çš„ç›®çš„ã€‚</p>
<h3 id="è¯»ä¹¦ï¼Œä¸æ˜¯ä¸ºäº†è€ƒè¯•"><a href="#è¯»ä¹¦ï¼Œä¸æ˜¯ä¸ºäº†è€ƒè¯•" class="headerlink" title="è¯»ä¹¦ï¼Œä¸æ˜¯ä¸ºäº†è€ƒè¯•"></a>è¯»ä¹¦ï¼Œä¸æ˜¯ä¸ºäº†è€ƒè¯•</h3><p>ä¸Šäº†å¤§å­¦åï¼Œé™¤äº†å°‘æ•°çš„ä¸“ä¸šä¹¦ç±ï¼Œå‡ ä¹æ€ä¹ˆçœ‹ä¹¦äº†ã€‚å°±è¿™æ ·æµ‘æµ‘å™©å™©è¿‡äº†ä¸¤å¹´ï¼Œä¸ä»…ä¸“ä¸šå¹¶æ²¡æœ‰å¤šå¤§çš„æå‡ï¼Œçœ¼ç•Œå’Œæ€ç»´ä¹Ÿæ˜¯åœæ»ä¸å‰ã€‚æ‰€å¹¸çš„æ˜¯è¿™ä¸¤å¹´åˆæ¡å›äº†è¯»ä¹¦çš„ä¹ æƒ¯ã€‚å¦‚æœåªä¾é è€ƒè¯•æ¥é­ç¬è‡ªå·±è¯»ä¹¦ï¼Œææ€•ä¹Ÿæ— æ³•åœ¨æœªæ¥èµ°çš„æ›´è¿œå§ã€‚</p>
<p>åœ¨è¿™é‡Œç®€å•åˆ—ä¸‹ä¹¦å•ï¼Œä¹Ÿç®—æ¨èä¸€äº›ä¹¦ç±</p>
<ul>
<li><a href="https://book.douban.com/subject/3369600/" target="_blank" rel="external">å½“æˆ‘è°ˆè·‘æ­¥æ—¶æˆ‘è°ˆäº›ä»€ä¹ˆ</a> æ˜¥ä¸Šæ˜¥æ ‘è®°å½•è‡ªå·±çš„è·‘æ­¥ä¸­ä¸€äº›éšæƒ³ã€‚çœ‹åˆ°å…¶ä¸­ä¸€äº›æƒ³æ³•å’Œè‡ªå·±è·‘æ­¥ä¸­æƒ³æ³•æœ‰ç›¸ä¼¼ä¹‹å¤„ã€‚</li>
<li><a href="https://book.douban.com/subject/26835090/" target="_blank" rel="external">Soft Skills: The software developerâ€™s life manual</a>ä»£ç ä¹‹å¤–çš„è½¯æŠ€èƒ½ã€‚ç¨‹åºå‘˜ä¸èƒ½åªåŸ‹å¤´æŠ€æœ¯ï¼Œè¿˜åº”è¯¥æŠ¬å¤´çœ‹çœ‹ä¸–ç•Œã€‚</li>
<li><a href="https://book.douban.com/subject/3432304/" target="_blank" rel="external">å¤§æ±Ÿä¸œå»</a>è®²æ”¹é©å¼€æ”¾å‰æœŸçš„å°è¯´ã€‚å‰ä¸¤éƒ¨ç»™æˆ‘çš„å¯å‘å¾ˆå¤šã€‚</li>
<li><a href="https://book.douban.com/subject/4239246/" target="_blank" rel="external">å¸‚åœºçš„åŠ›é‡</a>æœ‰ç‚¹æµ…ï¼Œå®ä¾‹ä¸é”™ã€‚</li>
<li><a href="https://book.douban.com/subject/7057936/" target="_blank" rel="external">æ‰¹åˆ¤æ€§æ€ç»´ï¼šå¸¦ä½ èµ°å‡ºæ€ç»´è¯¯åŒº</a>ä¸­æ–‡ç¿»è¯‘æœ‰äº›æ— æ³•è¡¨è¾¾å®Œå–„ï¼Œä½†å†…å®¹çš„ç¡®è¯¦å®ï¼Œæœ‰èƒ½åŠ›çš„æ¨èçœ‹åŸç‰ˆ</li>
<li><a href="https://book.douban.com/subject/5290524/" target="_blank" rel="external">å¾®é©å‘½</a>å†…å®¹åæ°´ï¼Œæ€è€ƒçš„ç‚¹ä¸é”™ã€‚</li>
</ul>
<p>16å¹´å› ä¸ºæ¯•ä¸šï¼Œæ²¡èƒ½å®Œæˆè‡ªå·±åœ¨å¹´åˆå®šä¸‹çš„è¯»ä¹¦è®¡åˆ’ã€‚17å¹´ä¸è¯¥å†æœ‰å€Ÿå£ã€‚è¯»ä¹¦ï¼Œåº”è¯¥æ˜¯ä¸€è¾ˆå­çš„äº‹æƒ…ã€‚</p>
<h3 id="æŠ€æœ¯"><a href="#æŠ€æœ¯" class="headerlink" title="æŠ€æœ¯"></a>æŠ€æœ¯</h3><p>ä½œä¸ºç¨‹åºå‘˜ï¼Œå¹´ç»ˆæ€»ç»“æ€ä¹ˆèƒ½ä¸å†™æŠ€æœ¯å‘¢ï¼Ÿä¸è¿‡ï¼Œæˆ‘ä¸æ‰“ç®—åœ¨è¿™é‡Œå†™å¾ˆå¤šæŠ€æœ¯å†…å®¹ï¼Œåªæƒ³è°ˆè°ˆå¯¹ç¼–ç¨‹æŠ€æœ¯çš„ä¸€äº›æ€è€ƒã€‚</p>
<p>ç¼–ç¨‹æŠ€æœ¯ï¼Œæ€»çš„æ¥è¯´æˆ‘è®¤ä¸ºä¹Ÿå±äºå·¥ç¨‹æŠ€æœ¯çš„ä¸€ç§ï¼Œè€Œä¸”æ˜¯å±äºé—¨æ§›è¾ƒä½çš„éƒ¨åˆ†ã€‚å›ä¸è§æ»¡è¡—40å¤©åŸ¹è®­Androidï¼ŒiOSï¼Œwebæœˆè–ªè¿‡ä¸‡ã€‚ç„¶è€Œï¼Œåªæœ‰æ½®é€€äº†æ‰çŸ¥é“è°åœ¨è£¸æ³³ã€‚16å¹´çš„èµ„æœ¬å¯’å†¬ä¹Ÿå½±å“åˆ°äº†ç‚™æ‰‹å¯çƒ­çš„äº’è”ç½‘äº§ä¸šã€‚ä¸€æ‰¹æ‰¹åˆ›ä¸šå…¬å¸å€’ä¸‹ä½¿åˆçº§å¼€å‘ä¸¥é‡è¿‡å‰©ã€‚ä¸€ä¸ªiOSå²—ä½ä¸€å‘¨å‡ ç™¾ä¸Šåƒå°ç®€å†ä¸æ˜¯å¤¸å¼ ã€‚ä½œä¸ºä¸€ååˆšæ¯•ä¸šè¿›å…¥å·¥ä½œå²—ä½çš„å¼€å‘ï¼Œè¯´æ²¡æœ‰æ‹…å¿ƒé‚£æ˜¯å‡çš„ã€‚ç©¶ç«Ÿåœ¨å‡ å¹´åå¦‚ä½•ä¿æŒä¸€å®šçš„ç«äº‰åŠ›ï¼Ÿè¿™äº›ä¸ªä¸€ç›´åœ¨æ€è€ƒè¿™äº›é—®é¢˜ã€‚</p>
<p>å¹¿ä¹‰ä¸Šçš„ä¿¡æ¯æŠ€æœ¯å‘å±•å·²ç»æœ‰å‡ åä¸ªå¹´å¤´äº†ï¼Œè€Œæ–°æ¦‚å¿µè¿˜åœ¨å±‚å‡ºä¸ç©·ã€‚æœºå™¨å­¦ä¹ ï¼ŒAR,VR,å¤§æ•°æ®ç­‰ç­‰åå­—å®¹æ˜“è®©æ–°è¿›è¡Œä¸šçš„äººå¤´æ™•çœ¼èŠ±ã€‚ä¸èƒ½ä¸æ‰¿è®¤ï¼ŒAPPæ—¶ä»£å·²ç»å¼€å§‹æ‹‰ä¸‹å¸·å¹•äº†ï¼Œæœªæ¥ç©¶ç«Ÿåœ¨å“ªï¼Œè°ä¹Ÿç»™ä¸å‡ºä¸€ä¸ªå‡†ç¡®çš„ç­”æ¡ˆã€‚è·Ÿç€è¡Œä¸šèµ°çš„æŠ€æœ¯ä¹Ÿåªèƒ½è·Ÿç€è¡Œä¸šçš„å…´è¡°ã€‚ä½œä¸ºæŠ€æœ¯ï¼Œä¸èƒ½åªç€çœ¼ä¸€å¤„ï¼Œä¿æŒå­¦ä¹ ï¼Œæ‰èƒ½æ°¸è¿œä¸è¢«æ‹‰ä¸‹ã€‚</p>
<h3 id="17å¹´ï¼Œè·¯åœ¨å“ªé‡Œ"><a href="#17å¹´ï¼Œè·¯åœ¨å“ªé‡Œ" class="headerlink" title="17å¹´ï¼Œè·¯åœ¨å“ªé‡Œ"></a>17å¹´ï¼Œè·¯åœ¨å“ªé‡Œ</h3><p>çµ®å¨åŠå¤©ï¼Œå‘ç°è‡ªå·±çš„è¡Œæ–‡ä¾æ—§è¿™ä¹ˆçƒ‚ï¼ˆé€ƒã€‚å¹´ç»ˆæ€»ç»“ï¼Œä¸å°±æ˜¯åº”è¯¥ç»™æœªæ¥çš„è‡ªå·±é¿å…è¸©ä¸ŠåŒä¸€ä¸ªå‘å—ã€‚17å¹´ä¼šæ€ä¹ˆæ ·ï¼Œæˆ‘ä¸çŸ¥é“ã€‚ä½†æ˜¯æˆ‘æƒ³æˆ‘åº”è¯¥è®©è‡ªå·±çŸ¥é“17è¯¥æ€ä¹ˆæ ·ã€‚</p>
<p>è¯»ä¹¦ä¾æ—§æ˜¯ä¸å¯å°‘çš„ï¼Œä¿æŒä¸€ä¸ªæœˆä¸€æœ¬çš„èŠ‚å¥ã€‚</p>
<p>æŠ€æœ¯ä¸Šï¼Œæœ¬èŒä¸Šçš„iOSå®¢æˆ·ç«¯å¼€å‘è¦æ·±æŒ–ä¸‹å»ï¼Œä¸èƒ½åœç•™åœ¨è¡¨é¢çš„åº”ç”¨äº†ã€‚åˆæ¬¡ä¹‹å¤–ï¼Œå­¦å­¦æ•°æ®å¤„ç†åˆ†æç›¸å…³çš„æŠ€æœ¯å§ã€‚</p>
<p>é”»ç‚¼ï¼Œ16å¹´çš„æ–­æ–­ç»­ç»­çš„ï¼Œæ²¡èƒ½ä¿æŒä¸€å®šæƒ¯æ€§ã€‚é”»ç‚¼æ˜¯æœ€è€ƒéªŒä¸€ä¸ªäººæ„å¿—åŠ›çš„è¡Œä¸ºã€‚17å¹´è¦ä¿æŒï¼Œåªæœ‰ä¸€ä¸ªå¥½èº«ä½“æ‰èƒ½åº”ä»˜ä¸€åˆ‡ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://csbzhixing.github.io/2016/12/19/æµ…è°ˆä¸€ç‚¹é¢è¯•ä½“éªŒ/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="csbzhixing">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://p3.pstatp.com/large/ab000310321818ab99.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="å­¦æµ·æ— æ¶¯">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="å­¦æµ·æ— æ¶¯" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/19/æµ…è°ˆä¸€ç‚¹é¢è¯•ä½“éªŒ/" itemprop="url">
                  ä»é¢è¯•æƒ³åˆ°çš„
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-19T09:50:41+08:00">
                2016-12-19
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="æµ…è°ˆä¸€ç‚¹é¢è¯•ä½“éªŒ"><a href="#æµ…è°ˆä¸€ç‚¹é¢è¯•ä½“éªŒ" class="headerlink" title="æµ…è°ˆä¸€ç‚¹é¢è¯•ä½“éªŒ"></a>æµ…è°ˆä¸€ç‚¹é¢è¯•ä½“éªŒ</h1><p>æœ€è¿‘éƒ¨é—¨ä¸šåŠ¡æ‰©å±•ï¼Œç§»åŠ¨ç«¯ç»ˆäºè¿æ¥äº†éš¾å¾—æ‹›äººçš„æœºä¼šã€‚åœ¨ç»å†åŠä¸ªæœˆçš„æ‹›è˜ä½“éªŒåï¼Œæ„Ÿè§¦è‰¯å¤šï¼Œæƒ³æ€»ç»“ä¸‹è¿™åŠä¸ªæœˆçš„ä½“éªŒä»¥åŠä¸€ç‚¹æƒ³æ³•</p>
<h2 id="ç§»åŠ¨ç«¯æ€ä¹ˆäº†"><a href="#ç§»åŠ¨ç«¯æ€ä¹ˆäº†" class="headerlink" title="ç§»åŠ¨ç«¯æ€ä¹ˆäº†"></a>ç§»åŠ¨ç«¯æ€ä¹ˆäº†</h2><p> åœ¨æŒ‚å‡ºç®€å†äº†ä¸åˆ°ä¸€å¤©ï¼Œé‚®ç®±å°±è¢«ä¸Šç™¾å°ç®€å†è½°ç‚¸äº†ã€‚è™½ç„¶å¯¹ä»Šå¤©å°±ä¸šå½¢åŠ¿æœ‰ä¸€äº›è€³é—»ï¼Œä½†æ˜¯ç¢°åˆ°å¦‚æ­¤æƒ…å½¢è¿˜æ˜¯æœ‰ç‚¹æƒŠè®¶ã€‚åˆ°æ˜¨å¤©ï¼Œæ•´æ•´æ”¶åˆ°äº†600å¤šå°iOSç®€å†ã€‚iOSå¼€å‘ç©¶ç«Ÿæ€ä¹ˆäº†ï¼Ÿæ˜¯è‹¹æœä¸è¡Œäº†å—ï¼Ÿå…¶å®å¹¶ä¸æ˜¯iOSå¼€å‘ä¸è¡Œäº†ï¼Œè€Œæ˜¯ç§»åŠ¨ç«¯çš„é£å£è¿‡äº†ã€‚åœ¨ç®€å†ä¸­ï¼Œæˆ‘çœ‹åˆ°äº†å½¢å½¢è‰²è‰²è‰²çš„é¡¹ç›®ã€‚ä»2Cçš„æ•™è‚²ï¼ŒåŒ»ç–—ï¼Œç›´æ’­ç­‰ç­‰ï¼Œåˆ°2Bçš„IMï¼Œé¡¹ç›®ç®¡ç†ç­‰ç­‰ï¼Œè¿™äº›é¡¹ç›®éƒ½æœ‰ä¸€ä¸ªç‰¹ç‚¹ â€” å¼€å‘æ—¶é—´ç‰¹åˆ«çŸ­ã€‚å‡ ä¹æ²¡æœ‰ä¸€ä¸ªé¡¹ç›®æ˜¯åœ¨ä¸€ä¸ªäººæ‰‹é‡Œå¼€å‘è¶…è¿‡1å¹´çš„ã€‚åŒæ—¶ï¼Œå‡ ä¹æ¯ä¸ªäººæ‰‹é‡Œéƒ½æœ‰å››äº”ä¸ªé¡¹ç›®ï¼Œç”šè‡³ä¸€ä¸ªåˆšå·¥ä½œä¸€å¹´çš„äººçš„ç®€å†é‡Œå°±å†™äº†å››ä¸ªé¡¹ç›®ã€‚å¯è§ï¼Œåœ¨è¿‡å»ä¸€ä¸¤å¹´ï¼Œç§»åŠ¨ç«¯å¼€å‘è¿‡çƒ­å¯¼è‡´è®¸å¤šå…¬å¸ç›²ç›®çš„ä¸Šé¡¹ç›®ã€‚å…¶ä¸­å°è±¡æ·±åˆ»çš„æ˜¯ï¼Œå…‰æ±½è½¦è“ç‰™ç›¸å…³çš„APPå°±æœ‰åå‡ ä¸ªã€‚ä¸è¿‡åœ¨æ±½è½¦ä¸Šé©¾é©¶å‘˜ä½¿ç”¨æ‰‹æœºçš„é—®é¢˜ï¼Œå°±è¯´æœ‰å¤šå°‘äººçœŸçš„éœ€è¦ä¸€ä¸ªAPPæ¥é€šè¿‡è“ç‰™æ§åˆ¶æ±½è½¦åŠŸèƒ½ï¼Ÿè¿™äº›é¡¹ç›®å¾€å¾€åœ¨åŠŸèƒ½ç®€å•çš„åŒæ—¶ï¼Œæ²¡æœ‰å¤ªå¤šçš„æŠ€æœ¯éš¾åº¦ï¼Œä»…ä»…æ˜¯ä¸ºäº†å®Œæˆå…¬å¸äº§å“è€Œç”Ÿæˆçš„ã€‚åœ¨é¢è¯•çš„è¿‡ç¨‹ä¸­ï¼Œç®€å•é—®äº†äº›è“ç‰™åè®®çš„å®ç°ï¼Œå‡ ä¹100%çš„é¢è¯•è€…éƒ½è¯´é€šè¿‡ä¸‰æ–¹å®ç°çš„ã€‚éšç€æŠ•èµ„çƒ­æ½®è¤ªå»ï¼Œè¿™äº›é¡¹ç›®çš„ä¸€æ‰¹æ‰¹çš„æ­»å»ï¼Œè‡ªç„¶é‡Šæ”¾å‡ºäº†è®¸å¤šåˆçº§ç§»åŠ¨ç«¯å¼€å‘(å°¤å…¶iOS)ã€‚ç§»åŠ¨ç«¯å¹¶æ²¡æœ‰æ­»å»ï¼Œè€Œæ˜¯èµ°å‘ç†æ™ºï¼Œåªæ˜¯åœ¨é£å£ä¸Šçš„çŒªæ‰äº†ä¸‹æ¥ã€‚</p>
<h2 id="è¯·ä¸è¦å†™ç²¾é€šå¥½å—"><a href="#è¯·ä¸è¦å†™ç²¾é€šå¥½å—" class="headerlink" title="è¯·ä¸è¦å†™ç²¾é€šå¥½å—"></a>è¯·ä¸è¦å†™ç²¾é€šå¥½å—</h2><p> åœ¨ç­›é€‰ç®€å†çš„æ—¶å€™ï¼Œçœ‹åˆ°ç²¾é€šå’Œç†Ÿç»ƒçš„æ¬¡æ•°å‡ ä¹æ˜¯ä¸€æ ·å¤šã€‚å‚ä¸ç«è˜çš„äººå‘˜å‡ ä¹éƒ½æ˜¯1-3å¹´ç»éªŒã€‚æ€ä¹ˆæ ·æ‰å¯ä»¥è¯´å¯¹æŸé¡¹æŠ€èƒ½è¾¾åˆ°äº†ç²¾é€šçš„åœ°æ­¥ï¼Ÿæˆ‘è®¤ä¸ºï¼Œè‡³å°‘åœ¨å¯¹äºè¿™é¡¹æŠ€èƒ½ï¼Œæ— è®ºç†è®ºè¿˜æ˜¯åº”ç”¨éƒ½è¾¾åˆ°äº†çƒ‚ç†Ÿäºå¿ƒçš„åœ°æ­¥ã€‚åœ¨å¼€å§‹æ—¶ï¼Œå¯¹äºç®€å†ä¸Šå†™ç€ç²¾é€šçš„é¢è¯•è€…ï¼Œæˆ‘æ— ä¸æŠ±ç€æ¢è®¨çš„å¿ƒæ€å»è®¨è®ºã€‚ç„¶è€Œï¼Œè¿„ä»Šä¸ºæ­¢ï¼Œå‡ ä¹æ²¡æœ‰ç²¾é€šOCçš„é¢è¯•è€…èƒ½å¤Ÿè®²æ¸…æ¥š<code>atomic</code> å’Œ <code>nonatomic</code>çš„åŒºåˆ«ï¼Œä¸ºä»€ä¹ˆå¸¸ç”¨<code>nonatomic</code>ï¼Œä¸ºä»€ä¹ˆç”¨<code>atomic</code>ä¹Ÿä¸èƒ½ä¿è¯å®‰å…¨ã€‚è‡³äºç²¾é€šTCP/UPDçš„ï¼Œç”šè‡³ä¸èƒ½å‡†ç¡®è®²å‡ºTCPè¿æ¥æ–­å¼€çš„è¿‡ç¨‹ã€‚æ­£å¦‚æœ‰å¥è¯ï¼šæ‡‚çš„è¶Šå¤šï¼Œè¶Šè§‰å¾—è‡ªå·±ä¸æ‡‚ã€‚</p>
<h2 id="ä¸å¥½æ„æ€ï¼Œæˆ‘æ²¡æƒ³è¿‡"><a href="#ä¸å¥½æ„æ€ï¼Œæˆ‘æ²¡æƒ³è¿‡" class="headerlink" title="ä¸å¥½æ„æ€ï¼Œæˆ‘æ²¡æƒ³è¿‡"></a>ä¸å¥½æ„æ€ï¼Œæˆ‘æ²¡æƒ³è¿‡</h2><p>è¿™ææ€•æ˜¯æˆ‘å¬è¿‡æœ€å¤šçš„ä¸€å¥è¯ï¼Œä¹Ÿæ˜¯æˆ‘å¬ä¸æ„¿å¬åˆ°ä¸€å¥è¯ã€‚ä½œä¸ºä¸€ä¸ªå¼€å‘ï¼Œæ¯å¤©æˆ‘ä»¬éƒ½èƒ½é‡åˆ°å„ç§å„æ ·çš„é—®é¢˜ã€‚ç„¶è€Œé‡åˆ°äº†é—®é¢˜ï¼Œæˆ‘ä»¬æ˜¯ç®€å•çš„ç™¾åº¦ä¸€ä¸‹ï¼Œè¿˜æ˜¯åœä¸‹æ¥æƒ³æƒ³åé¢çš„åŸå› ï¼Ÿæ¯é€¢è°ˆåˆ°å¾ªç¯å¼•ç”¨ï¼Œå‡ ä¹éƒ½è°ˆåˆ°blockä¸­çš„æƒ…å†µã€‚ç„¶è€Œå¦‚æœæˆ‘ç›´æ¥é—®é“é™¤äº†blockä¸­çš„æƒ…å†µå‘¢ï¼Œå‡ ä¹80%çš„é¢è¯•è€…éƒ½æ‡µé€¼äº†ã€‚æˆ‘æƒ³ï¼Œå¦‚æœçœŸæ­£ç†è§£äº†å¾ªç¯å¼•ç”¨ï¼Œä¸å¯èƒ½åªèƒ½æƒ³åˆ°blockä¸­è¿™ä¹ˆä¸€ç§æƒ…å†µã€‚è°ˆåˆ°<code>autoreleasepool</code>çš„ç†è§£å’Œç”¨æ³•ã€‚é™¤äº†ç®€å•å’Œ<code>ARC</code>å…³è”åœ¨ä¸€èµ·(å…¶å®è¿™é‡Œä¸è¯¥æ··æ·†åœ¨ä¸€èµ·)ï¼Œå°±åªä¼šç®€å•çš„è¯´ä¸çŸ¥é“äº†ã€‚ç„¶è€Œï¼Œåœ¨<code>main.m</code>æ–‡ä»¶ä¸­å…¶å®å°±ç”¨äº†<code>autorealesepool</code></p>
<pre><code>    @autoreleasepool {
        return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));
    }
</code></pre><h2 id="è¯·å†™ä¸Šä½ ç†Ÿæ‚‰çš„ï¼Œè€Œä¸æ˜¯ä»…ä»…ç”¨è¿‡çš„"><a href="#è¯·å†™ä¸Šä½ ç†Ÿæ‚‰çš„ï¼Œè€Œä¸æ˜¯ä»…ä»…ç”¨è¿‡çš„" class="headerlink" title="è¯·å†™ä¸Šä½ ç†Ÿæ‚‰çš„ï¼Œè€Œä¸æ˜¯ä»…ä»…ç”¨è¿‡çš„"></a>è¯·å†™ä¸Šä½ ç†Ÿæ‚‰çš„ï¼Œè€Œä¸æ˜¯ä»…ä»…ç”¨è¿‡çš„</h2><p>åœ¨ç­›é€‰ç®€å†çš„æ—¶å€™ï¼Œç®€å†ä¸Šæœ‰ä¸€äº›æ–°æ„çš„å­—çœ¼çš„ç¡®æœ‰åŠ åˆ†é¡¹ã€‚æ¯”å¦‚<code>swift3</code>çš„å¼€å‘ç»å†ï¼Œç½‘ç»œå’Œæ¸²æŸ“çš„ä¼˜åŒ–ï¼Œç†Ÿæ‚‰ç¬¬ä¸‰æ–¹åº“çš„å®ç°(<code>YYKit</code>,<code>SDWebImage</code>ç­‰ç­‰)ã€‚ç„¶è€Œï¼Œå½“ä½ åœ¨ç®€å†ä¸Šä½“ç°å‡ºæ¥è¿™äº›ä¸œè¥¿æ—¶å€™ï¼Œèµ·ç è‡ªå·±è¦ç†Ÿæ‚‰ã€‚ä»…ä»…ä½¿ç”¨swiftå†™äº†ä¸€ä¸ªdemoå¯ä¸èƒ½ç†Ÿæ‚‰swiftã€‚swiftçš„ç‰¹æ€§ï¼Œæ¯”å¦‚æŸ¯é‡ŒåŒ–ï¼Œæ¯”å¦‚enum,structs,classçš„åŒºåˆ«å’Œé€‰å‹è€ƒè™‘ï¼Œè¿™äº›é—®é¢˜å¦‚æœéƒ½æ²¡æœ‰è€ƒè™‘ï¼Œä»…ä»…æŠŠä¸€ä¸ªdemoä»ocè½¬æˆswiftä¹Ÿä»…ä»…åœ¨è¯­è¨€å±‚é¢çš„è½¬åŒ–è€Œå·²ã€‚è€Œä¼˜åŒ–çš„éƒ¨åˆ†ï¼Œèµ·ç è¦ææ¸…æ¥šä¼˜åŒ–çš„æ„ä¹‰åœ¨å“ªé‡Œï¼Œä¸ºä½•éœ€è¦ä¼˜åŒ–ï¼Œä»…ä»…å°è£…ä¸šåŠ¡ç›¸å…³å†…å®¹å¯ä¸æ˜¯ä¼˜åŒ–ã€‚è€Œç¬¬ä¸‰æ–¹åº“ç†è§£ï¼Œä¸è¯¥åªæ˜¯åœ¨è°ƒè°ƒAPIè¿™æ ·ã€‚æ— è®ºå¤šä¹ˆä¼˜ç§€çš„ç¬¬ä¸‰æ–¹å®ç°éƒ½æœ‰è‡ªå·±çš„ä¸è¶³å’Œå¯ä»¥æ”¹è¿›çš„åœ°æ–¹ã€‚åªæœ‰è‡ªå·±è¯»äº†æºç ï¼Œè®¤çœŸå»æ€è€ƒï¼Œåˆ†è¾¨ä¼˜åŠ£ï¼Œæ‰èƒ½è°ˆå¾—ä¸Šç†è§£ã€‚</p>
<h2 id="è¯·ä¸è¦è¯´ç”¨ä¸åˆ°"><a href="#è¯·ä¸è¦è¯´ç”¨ä¸åˆ°" class="headerlink" title="è¯·ä¸è¦è¯´ç”¨ä¸åˆ°"></a>è¯·ä¸è¦è¯´ç”¨ä¸åˆ°</h2><p>è¿™å¥è¯æœ€å¤šå¬åˆ°çš„æ˜¯åœ¨é—®ç®—æ³•çš„æ—¶å€™ã€‚å¤±æœ›çš„æ˜¯ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿˜æ²¡æœ‰äººèƒ½ç­”å‡ºå‡ é“ç®€å•çš„ç®—æ³•å’Œæ•°æ®ç»“æ„ç›¸å…³çš„é¢˜ç›®ã€‚ä¸€ä¸ªç®€å•çš„æ±‚ä¸¤ä¸ªæ•°çš„æœ€å¤§å…¬çº¦æ•°å‡ ä¹æ²¡æœ‰äººèƒ½ç»™å‡ºæƒ³æ³•(æ²¡é”™ï¼Œå°±æ˜¯ç›´æ¥è¯´ä¸ä¼š)ã€‚è€Œå½’å¹¶æ’åºï¼Œå¿«æ’ï¼ŒäºŒåˆ†æŸ¥æ‰¾æ›´æ˜¯æ— äººèƒ½è¯´å‡ºä¸€äºŒã€‚iOSå¼€å‘çœŸçš„ä¸éœ€è¦ç”¨åˆ°ç®—æ³•å’Œæ•°æ®ç»“æ„å—ï¼Ÿæˆ‘æƒ³ä¸æ˜¯çš„ã€‚å…¶å®å¾ˆå¤šåŠ£è´¨çš„ä»£ç å¾€å¾€æ˜¯å¯¹æ•°æ®ç»“æ„å’Œç®—æ³•çš„ä¸ç†Ÿæ‚‰å¯¼è‡´çš„ã€‚è®°å¾—ä¸€ä¸ªéå¸¸å¸¸è§çš„ä¾‹å­ï¼šæ–°å¢æ•°æ®çš„æ¯”å¯¹ã€‚æ¯”å¦‚å¢é‡ä¸ŠæŠ¥é€šè®¯å½•ï¼Œå¾ˆå¤šäººæ—ºæ—ºæ˜¯åšforå¾ªç¯åµŒå¥—ã€‚ç„¶è€Œå¦‚æœèƒ½ç”¨åˆ°hashè¡¨ï¼Œæ•ˆç‡èƒ½æœ‰é‡çº§çš„æé«˜ã€‚è™½ç„¶å¦‚ä»ŠiOSå¼€å‘èƒ½çœŸçš„éœ€è¦è‡ªå·±å»æ‰‹å†™ç®—æ³•çš„åœ°æ–¹å¾ˆå°‘ï¼Œä½†å¦‚æœå°±æ­¤ä¸å»å­¦ä¹ ï¼Œä¸è¯´ä¸èƒ½æ›´è¿›ä¸€æ­¥ï¼Œå¯èƒ½è¿˜ä¼šäº§å‡ºè®¸å¤šåŠ£è´¨çš„ä»£ç ã€‚</p>
<h2 id="åŸºç¡€ï¼Œç¦»ä¸å¼€çš„åŸºç¡€"><a href="#åŸºç¡€ï¼Œç¦»ä¸å¼€çš„åŸºç¡€" class="headerlink" title="åŸºç¡€ï¼Œç¦»ä¸å¼€çš„åŸºç¡€"></a>åŸºç¡€ï¼Œç¦»ä¸å¼€çš„åŸºç¡€</h2><p>ç»è¿‡å¤šæ¬¡é¢è¯•åï¼ŒHRåé¦ˆç»™æˆ‘ï¼Œè¯´é¢è¯•è€…è®¤ä¸ºæˆ‘è€ƒçš„å†…å®¹åå‘äºâ€œæ­»â€çš„å†…å®¹ï¼Œè€Œå¼€æ”¾æ€§å…³äºé¡¹ç›®çš„å†…å®¹å¾ˆå°‘ã€‚ç¬”è€…åœ¨è¿™é‡Œé˜è¿°ä¸‹è‡ªå·±çš„è§‚ç‚¹ã€‚ä¸‡ä¸ˆé«˜æ¥¼å¹³åœ°èµ·ï¼Œå†ç‰›çš„äººï¼Œå†å¥½çš„é¡¹ç›®ï¼Œæ— ä¸æ˜¯ä»ä¸€ç‚¹ç‚¹åŸºç¡€å¼€å§‹çš„ã€‚ç¦»å¼€äº†æ‰å®çš„åŸºç¡€ï¼Œæˆ‘ä¸è®¤ä¸ºè®²å¼€æ”¾æ€§çš„å†…å®¹èƒ½å¤Ÿè¯´å‡ºç‹¬ç‰¹çš„è§è§£ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä¹Ÿé—®è¿‡ä¸€äº›å¼€æ”¾æ€§çš„å†…å®¹ï¼Œæ¯”å¦‚æ¸²æŸ“çš„ä¼˜åŒ–ï¼Œç½‘ç»œä¼˜åŒ–çš„ç‚¹ã€‚ç„¶è€Œï¼Œå¯¹viewæ¸²æŸ“çš„æœºåˆ¶æ·±å…¥çš„ä¸å¤Ÿä»¥åŠå¯¹ç½‘ç»œåè®®çš„æµ…è–„è§è§£ï¼Œå½±å“åˆ°äº†è®¸å¤šäººèƒ½è°ˆçš„å¾ˆå°‘ã€‚æ‰€ä»¥ï¼Œæˆ‘åœ¨åé¢çš„é¢è¯•ï¼Œä¾ç„¶ä¼šåšæŒå¯¹åŸºç¡€çš„è€ƒæ ¸ï¼Œæ¯•ç«Ÿï¼ŒåŸºç¡€æ‰å®äº†ï¼Œå†å»åšæ·±å…¥çš„æ¢ç´¢ä¹Ÿä¸ä¼šæœ‰å¤ªå¤§çš„å›°éš¾ã€‚</p>
<h2 id="ä¸‰å¹´ï¼Œè¿˜æ˜¯ä¸€"><a href="#ä¸‰å¹´ï¼Œè¿˜æ˜¯ä¸€" class="headerlink" title="ä¸‰å¹´ï¼Œè¿˜æ˜¯ä¸€"></a>ä¸‰å¹´ï¼Œè¿˜æ˜¯ä¸€</h2><p>åœ¨å‰æ–‡è¯´åˆ°ï¼Œå‚ä¸é¢è¯•çš„äººéƒ½æ˜¯æœ‰ä¸¤ä¸‰å¹´å¼€å‘ç»éªŒï¼Œæœ‰æ•°ä¸ªé¡¹ç›®ç»éªŒåœ¨èº«çš„ã€‚ç„¶è€Œåœ¨æˆ‘çœ‹æ¥ï¼Œä»–ä»¬ä»…ä»…æ˜¯æŠŠä¸€å¹´ç»éªŒï¼Œåå¤ç”¨äº†ä¸‰å¹´è€Œå·²ï¼Œç”šè‡³ï¼Œæˆ‘è®¤ä¸ºå…¶ä¸­æœ‰äº›äººç”šè‡³ä¸å¦‚ä¼˜ç§€çš„åº”å±Šã€‚ä¸ºä½•ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼Œåœ¨æˆ‘çœ‹æ¥å¤šæ•°åŸå› åœ¨äºæŠŠè‡ªå·±çš„çœ¼ç•Œå›°æ­»äº†ã€‚å‡ ä¹æ‰€æœ‰äººçš„ç®€å†ä¸Šéƒ½å†™ç€èƒ½å¤Ÿå®Œæˆä¸€ä¸ªå®Œæ•´çš„appã€‚ä½†æ˜¯åœ¨æˆ‘çœ‹æ¥ï¼Œå®Œæˆä¸€ä¸ªå®Œæ•´APPæ˜¯ä¸€ä¸ªæœ‰ä¸€å¹´å¼€å‘ç»éªŒåˆæ ¼çš„iOSå¼€å‘å°±èƒ½åšåˆ°çš„ã€‚è€Œä¸¤ä¸‰å¹´ç»éªŒçš„å¼€å‘ï¼Œåº”è¯¥æ›´å¤šå»æ·±å…¥ç»†èŠ‚ï¼Œä¸²è”è‡ªå·±çš„çŸ¥è¯†ã€‚è®°å¾—æˆ‘å¸¸é—®ä¸€ä¸ªé—®é¢˜ï¼šiOSä¸­æœ‰å“ªäº›é”çš„å®ç°æ–¹æ³•ï¼Ÿå°‘æ•°äººèƒ½è°ˆåˆ°<code>NSLock</code>ï¼Œå¤šæ•°äººåªçŸ¥é“<code>synchronized</code>ã€‚æˆ‘ä¸æ˜¯å¾ˆç†è§£ä¸‰å¹´çš„å¼€å‘ç»å†å°±æ²¡æƒ³äº†è§£è¿‡å…¶ä»–çš„å®ç°å—ï¼Ÿå†µä¸”ç½‘ä¸Šè®²è§£çš„æ–‡ç« ä¹Ÿä¸å°‘ã€‚</p>
<p>åæ§½äº†é‚£ä¹ˆå¤šï¼Œå®é™…ä¸Šä¹Ÿæ˜¯æƒ³é­ç¬è‡ªå·±ã€‚å­¦æ— æ­¢å¢ƒï¼Œæœ‰å¤ªå¤šçš„ç‚¹éœ€è¦è‡ªå·±å»ç ”ç©¶ï¼Œæ°¸è¿œä¸èƒ½æ»¡è¶³ç°æœ‰çš„çŠ¶å†µï¼Œæ°¸è¿œä¸è¦è®©è‡ªå·±å¾…åœ¨èˆ’é€‚åŒºï¼Œåˆ‡è®°åˆ‡è®°ã€‚</p>
<p>åé¢å¯èƒ½ä¼šæ€»ç»“ä¸‹åœ¨é¢è¯•ä¸­é—®é“çš„é—®é¢˜ã€‚å®é™…ä¸Šæœ‰äº›é—®é¢˜ä¹Ÿæ˜¯æœ€è¿‘åœ¨å‡†å¤‡çš„æ—¶å€™å­¦ä¹ åˆ°äº†æ›´å¤šçš„å†…å®¹ï¼Œä¹Ÿç®—ä¸ºè‡ªå·±çš„çŸ¥è¯†ä½“ç³»åšäº†è¡¥å……ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://csbzhixing.github.io/2016/08/23/ RN--WEEX--JSPATCH/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="csbzhixing">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://p3.pstatp.com/large/ab000310321818ab99.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="å­¦æµ·æ— æ¶¯">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="å­¦æµ·æ— æ¶¯" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/23/ RN--WEEX--JSPATCH/" itemprop="url">
                  Weex, React Native, JSPatch
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-23T23:16:32+08:00">
                2016-08-23
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æœ¬æ–‡æ˜¯åšå†…éƒ¨åˆ†äº«çš„æ—¶å€™æ•´ç†çš„çŸ¥è¯†å†…å®¹ï¼Œæ•´ç†äº†å‡ºæ¥ã€‚</p>
<h2 id="æŠ€æœ¯ä»‹ç»"><a href="#æŠ€æœ¯ä»‹ç»" class="headerlink" title="æŠ€æœ¯ä»‹ç»"></a>æŠ€æœ¯ä»‹ç»</h2><h3 id="Weex"><a href="#Weex" class="headerlink" title="Weex"></a>Weex</h3><p>Weexæ˜¯é˜¿é‡Œæ‰‹æ·˜å¼€æºçš„ä¸€å¥—è·¨å¹³å°å¼€å‘ã€‚æ ¸å¿ƒè¯­æ³•å€Ÿé‰´äº†vue.jsã€‚</p>
<p>Weexæ˜¯è·¨å¹³å°ï¼Œå¯æ‰©å±•çš„åŠ¨æ€åŒ–æŠ€æœ¯. ä½ èƒ½é€šè¿‡åœ¨Weexæºç ä¸­å†™<code>&lt;template&gt;</code>, <code>&lt;style&gt;</code> å’Œ <code>&lt;script&gt;</code>æ ‡ç­¾ï¼Œç„¶åæŠŠè¿™äº›æ ‡ç­¾è½¬æ¢ä¸ºJS Bundleç”¨äºéƒ¨ç½², åœ¨æœåŠ¡ç«¯ä»¥è¿™äº›JS Bundleå“åº”è¯·æ±‚. å½“å®¢æˆ·ç«¯æ¥æ”¶åˆ°JS Bundleæ—¶ï¼Œå®ƒèƒ½ç”¨è¢«å®¢æˆ·ç«¯ä¸­çš„JSå¼•æ“ç”¨äºç®¡ç†Nativeæ¸²æŸ“;APIè°ƒç”¨å’Œç”¨æˆ·äº¤äº’.</p>
<h4 id="åŸºæœ¬è¯­æ³•"><a href="#åŸºæœ¬è¯­æ³•" class="headerlink" title="åŸºæœ¬è¯­æ³•"></a>åŸºæœ¬è¯­æ³•</h4><p> <code>&lt;template&gt;</code>æ˜¯å¿…é¡»çš„ï¼Œä½¿ç”¨ç±»HTMLçš„å½¢å¼ï¼Œå†…å®¹ç”±å¤šä¸ªæ ‡ç­¾ç»„æˆï¼Œä¸åŒæ ‡ç­¾ä»£è¡¨ä¸åŒçš„ç»„ä»¶ã€‚</p>
<p><code>&lt;style&gt;</code>ï¼Œå¯é€‰ï¼Œä½¿ç”¨ç±»CSSè¯­æ³•ã€‚</p>
<p><code>&lt;script&gt;</code> å¯é€‰ï¼Œä½¿ç”¨jsæè¿°é¡µé¢ä¸­é€»è¾‘å’Œæ•°æ®ï¼Œæ•°æ®å®šä¹‰ä¹Ÿåœ¨è¿™ä¸ªéƒ¨åˆ†</p>
<p><code>&lt;template&gt;</code> ä¸­æœ‰ä¸‰ç§ä¸åŒçš„æ ¹èŠ‚ç‚¹å½¢å¼</p>
<ol>
<li><code>&lt;container&gt;</code>ï¼Œæ™®é€šæ ¹èŠ‚ç‚¹</li>
<li><code>&lt;scroller&gt;</code>ï¼Œæ»šåŠ¨æ ¹èŠ‚ç‚¹ï¼Œé€‚ç”¨äºå…¨é¡µé¢æ»šåŠ¨</li>
<li><code>&lt;list&gt;</code>ï¼Œåˆ—è¡¨æ ¹èŠ‚ç‚¹ï¼Œé€‚ç”¨äºå¤ç”¨å…ƒç´ çš„åˆ—è¡¨åœºæ™¯ã€‚</li>
</ol>
<p><code>&lt;style&gt;</code> </p>
<p>ç±»ä¼¼CSSçš„å½¢å¼ï¼Œå’Œæ ‡å‡†CSSæœ‰ä¸€äº›ç»†å¾®çš„å·®åˆ«</p>
<p>ç¬¬ä¸€ç§ä½¿ç”¨å†…è”çš„æ–¹å¼ï¼Œé€šè¿‡styleå±æ€§ç›´æ¥æ·»åŠ æ ·å¼ã€‚ç¬¬äºŒç§é€šè¿‡<code>class</code>å±æ€§ä¸<code>style</code>å±æ€§å»ºç«‹å¯¹åº”å…³ç³»</p>
<pre><code>&lt;template&gt;
  &lt;container&gt;
    &lt;text style=&quot;font-size: 64;&quot;&gt;Alibaba&lt;/text&gt;
    &lt;text class=&quot;large&quot;&gt;Weex Team&lt;/text&gt;
  &lt;/container&gt;
&lt;/template&gt;

&lt;style&gt;
  .large {font-size: 64;}
&lt;/style&gt;``
</code></pre><p><code>&lt;script&gt;</code></p>
<p><code>&lt;script&gt;</code>ä¸­ä»£ç éµå¾ª<code>ES5</code>è¯­æ³•æ ‡å‡†</p>
<pre><code>&lt;template&gt;
  &lt;image onclick=&quot;handler&quot; ...&gt;&lt;/image&gt;
&lt;/template&gt;

&lt;script&gt;
  module.exports = {
    methods: {
      handler: function (e) {
        // TODO
      }
    }
  }
&lt;/script&gt;
</code></pre><p>å½“ä¸€ä¸ªäº‹ä»¶å‡½æ•°è¢«è°ƒç”¨ï¼Œå®ƒä¼šæ”¶åˆ°çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯äº‹ä»¶å¯¹è±¡ã€‚æ¯ä¸ªäº‹ä»¶å¯¹è±¡åŒ…å«ä¸€ä¸‹å±æ€§ã€‚</p>
<ol>
<li><code>type</code>,äº‹ä»¶åç§°ï¼Œå¦‚<code>click</code>ã€‚</li>
<li><code>target</code>ï¼Œç›®æ ‡å…ƒç´ </li>
<li><code>timestamp</code>,äº‹ä»¶è§¦å‘çš„æ—¶é—´æˆ³ã€‚</li>
</ol>
<h4 id="æ¸²æŸ“æµç¨‹"><a href="#æ¸²æŸ“æµç¨‹" class="headerlink" title="æ¸²æŸ“æµç¨‹"></a>æ¸²æŸ“æµç¨‹</h4><pre><code>
Weex we æ–‡ä»¶ ---------------å‰ç«¯(weæºç )
â†“ (è½¬æ¢) -------------------å‰ç«¯(æ„å»ºè¿‡ç¨‹)
JS Bundle -----------------å‰ç«¯(JS Bundleä»£ç )
â†“ (éƒ¨ç½²) -------------------æœåŠ¡å™¨
åœ¨æœåŠ¡å™¨ä¸Šçš„JS bundle  ------æœåŠ¡å™¨
â†“ (ç¼–è¯‘) ------------------ å®¢æˆ·ç«¯(JSå¼•æ“)
è™šæ‹Ÿ DOM æ ‘ --------------- å®¢æˆ·ç«¯(Weex JS Framework)
â†“ (æ¸²æŸ“) ------------------ å®¢æˆ·ç«¯(æ¸²æŸ“å¼•æ“)
Nativeè§†å›¾ ---------------  å®¢æˆ·ç«¯(æ¸²æŸ“å¼•æ“)
</code></pre><p>æ¸²æŸ“æµç¨‹</p>
<ol>
<li>è™šæ‹ŸDOM.</li>
<li>æ„é€ æ ‘ç»“æ„. åˆ†æè™šæ‹ŸDOM JSONæ•°æ®ä»¥æ„é€ æ¸²æŸ“æ ‘(RT).</li>
<li>æ·»åŠ æ ·å¼. ä¸ºæ¸²æŸ“æ ‘çš„å„ä¸ªèŠ‚ç‚¹æ·»åŠ æ ·å¼.</li>
<li>åˆ›å»ºè§†å›¾. ä¸ºæ¸²æŸ“æ ‘å„ä¸ªèŠ‚ç‚¹åˆ›å»ºNativeè§†å›¾.</li>
<li>ç»‘å®šäº‹ä»¶. ä¸ºNativeè§†å›¾ç»‘å®šäº‹ä»¶.</li>
<li>CSSå¸ƒå±€. ä½¿ç”¨ css-layout æ¥è®¡ç®—å„ä¸ªè§†å›¾çš„å¸ƒå±€.</li>
<li>æ›´æ–°è§†çª—(Frame). é‡‡ç”¨ä¸Šä¸€æ­¥çš„è®¡ç®—ç»“æœæ¥æ›´æ–°è§†çª—ä¸­å„ä¸ªè§†å›¾çš„æœ€ç»ˆå¸ƒå±€ä½ç½®.</li>
<li>æœ€ç»ˆé¡µé¢å‘ˆç°.</li>
</ol>
<h4 id="å­˜åœ¨çš„é—®é¢˜"><a href="#å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="å­˜åœ¨çš„é—®é¢˜"></a>å­˜åœ¨çš„é—®é¢˜</h4><ol>
<li>åˆšåˆšå¼€æºï¼Œç¤¾åŒºæ´»è·ƒåº¦ä¸é«˜ï¼Œä»¥é˜¿é‡Œå›¢é˜Ÿä¸ºä¸»</li>
<li>æ”¯æŒçš„æ§ä»¶æ¯”è¾ƒå°‘ï¼ˆæ¯”å¦‚buttonå°±æ²¡æœ‰ï¼‰ï¼Œcheckboxï¼Œradioä¹Ÿæ²¡æœ‰</li>
<li>ç„¦ç‚¹é—®é¢˜</li>
<li>CSSä¸æ”¯æŒçˆ¶çº§ç»§æ‰¿</li>
<li>æ–‡æ¡£ä¸å®Œå–„</li>
</ol>
<h4 id="å’ŒReact-Native-å¯¹æ¯”"><a href="#å’ŒReact-Native-å¯¹æ¯”" class="headerlink" title="å’ŒReact Native å¯¹æ¯”"></a>å’ŒReact Native å¯¹æ¯”</h4><h5 id="JSå¼•æ“ï¼š"><a href="#JSå¼•æ“ï¼š" class="headerlink" title="JSå¼•æ“ï¼š"></a>JSå¼•æ“ï¼š</h5><p>å®‰å“ä¸Š weexä½¿ç”¨V8ï¼Œ ReactNativeä½¿ç”¨JSCore</p>
<p>iOSä¸Šï¼Œéƒ½ä½¿ç”¨äº†JSCore</p>
<p>åŸå› æ˜¯ï¼ŒRNä¸ºäº†ä½¿ç”¨JSCoreï¼Œå°†æ•´ä¸ªJSCoreæ‰“åŒ…è¿›äº†appçš„webkitåº“ï¼Œæ‰€ä»¥å®‰å“çš„åŒ…ä½“å®¹é‡æœ‰æ¯”è¾ƒæ˜æ˜¾çš„å¢å¤§ã€‚è€ŒiOSåˆ™è‡ªå¸¦</p>
<p>weexè€ƒè™‘åˆ°åœ¨å®‰å“ä¸Šéƒ½éœ€è¦è‡ªå·±æ‰“åŒ…ï¼Œé‚£ä¹ˆå°±é€‰æ‹©äº†æ›´æ–°çš„V8å¼•æ“ï¼Œè€ŒiOSåˆ™ç»§ç»­ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„JSCore</p>
<h5 id="JSå¼€å‘æ¡†æ¶ï¼š"><a href="#JSå¼€å‘æ¡†æ¶ï¼š" class="headerlink" title="JSå¼€å‘æ¡†æ¶ï¼š"></a>JSå¼€å‘æ¡†æ¶ï¼š</h5><p>weexåŸºäºvue.js(2W+ star)ã€‚å°å·§è½»é‡çš„å‰ç«¯å¼€å‘æ¡†æ¶ï¼Œç»„ä»¶åŒ–ï¼Œæ•°æ®ç»‘å®šï¼Œ2.0å¼•å…¥virtual domã€‚</p>
<p>ReactNativeä½¿ç”¨React(4W+ star)ã€‚é©å‘½æ€§çš„å‰ç«¯å¼€å‘æ¡†æ¶ï¼Œç»„ä»¶åŒ–ï¼Œæ•°æ®ç»‘å®šï¼Œvirtual domã€‚</p>
<p>è¿™ä¸¤è€…ï¼Œvueæ›´ç¬¦åˆwebå¼€å‘çš„ä¹ æƒ¯ï¼ŒJSXæ”¹å˜æ¯”è¾ƒå¤§ï¼Œä½†æ˜¯æ€»ä½“è€Œè¨€ï¼Œç†Ÿæ‚‰webå¼€å‘éƒ½ä¸æ˜¯å¤§é—®é¢˜ï¼Œå¯¹äºåªæœ‰ç§»åŠ¨ç«¯å¼€å‘ç»éªŒçš„äººå¯èƒ½RNçš„å­¦ä¹ æˆæœ¬ç¨é«˜ã€‚</p>
<h5 id="å¸ƒå±€"><a href="#å¸ƒå±€" class="headerlink" title="å¸ƒå±€"></a>å¸ƒå±€</h5><p>å¸ƒå±€ä¸¤è€…éƒ½æ˜¯åŸºäºfacebookçš„ä»£ç è§£æï¼Œå®ç°äº†flexBoxçš„å­é›†</p>
<p>è¿™ä¸ªä»£ç è§£æï¼Œå†™èµ·æ¥æ˜¯çˆ½ï¼Œä½†æ˜¯ï¼Œå¯¹äºå¤æ‚çš„é¡µé¢ï¼Œä¼šäº§ç”Ÿæ¯”è¾ƒä¸¥é‡çš„æ€§èƒ½é—®é¢˜.</p>
<p>è¿™é‡Œæœ¬æ¥åˆ†äº«ç”¨äº†å†…éƒ¨é¡¹ç›®çš„å›¾ï¼Œè¿™é‡Œæ²¡æœ‰æ”¾å‡ºæ¥ã€‚å¤§å®¶å¯ä»¥è‡ªå·±ç”¨ä¸‰å¥—æ¡†æ¶å»å®ç°åŒä¸€ä¸ªé¡µé¢ï¼Œç”¨revealå»çœ‹ä¸‹å°±æ˜ç™½äº†ã€‚</p>
<p>èƒ½ä¸èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç½‘ä¸Šæœ‰äººæå‡ºäº†æ”¹å˜æ€è·¯çš„æ–¹å¼ï¼Œå³ä¸é€‚ç”¨å‰ç«¯å¸ƒå±€çš„æ€ç»´ç”¨jså»é©±åŠ¨Nativeç»˜å›¾ï¼Œè€Œæ˜¯ç”¨nativeçš„æ€è·¯å»ç”¨jsé©±åŠ¨ã€‚ä¸è¿‡è¿™æ ·çš„è¯ï¼Œå°±åŠ å¤§äº†å‰ç«¯äººå‘˜çš„å­¦ä¹ æˆæœ¬</p>
<h5 id="Moudleæ–¹æ³•è°ƒç”¨çº¿ç¨‹ï¼š"><a href="#Moudleæ–¹æ³•è°ƒç”¨çº¿ç¨‹ï¼š" class="headerlink" title="Moudleæ–¹æ³•è°ƒç”¨çº¿ç¨‹ï¼š"></a>Moudleæ–¹æ³•è°ƒç”¨çº¿ç¨‹ï¼š</h5><p>weex å¯ä»¥é€šè¿‡æ³¨è§£æ ‡æ³¨æ˜¯å¦åœ¨UIçº¿ç¨‹æ‰§è¡Œ</p>
<p>ReactNativeåœ¨å®‰å“ä¸Šæ˜¯åœ¨<code>native_modules</code>çº¿ç¨‹æ‰§è¡Œã€‚iOSé‡Œé¢ï¼Œæ¯ä¸€ä¸ª<code>native_modules</code>å¯ä»¥æ”¯æŒæ ‡è®°ï¼Œéœ€è¦é‡å†™moduleçš„<code>methodQueue</code>æ–¹æ³•ï¼Œå°±å¯ä»¥è·å¾—åœ¨<code>main_queue</code>ä¸­æ‰§è¡Œã€‚</p>
<pre><code>//RCTClipboardç±»çš„æºç 
- (dispatch_queue_t)methodQueue
{
  return dispatch_get_main_queue();
}
</code></pre><h5 id="æ‰©å±•æ€§"><a href="#æ‰©å±•æ€§" class="headerlink" title="æ‰©å±•æ€§"></a>æ‰©å±•æ€§</h5><p>ç»„ä»¶çš„æ‰©å±•ä¸Šï¼Œweexå’ŒReactNativeå…·æœ‰ä¸€æ ·çš„èƒ½åŠ›</p>
<p>ä¸‰æ–¹åº“çš„æ¥å…¥ä¸Šï¼Œweexå¯¹ç½‘ç»œï¼Œå›¾ç‰‡ï¼Œç»Ÿè®¡ç­‰å¸¸è§çš„ç”¨æˆ·å¯èƒ½æƒ³è‡ªå·±å®šåˆ¶çš„åŠŸèƒ½ï¼Œæä¾›äº†ç›¸åº”çš„é€‚é…æ¥å£ï¼Œå¯ä»¥ç”±ç”¨æˆ·æ–¹ä¾¿çš„å®šåˆ¶ï¼ŒReactNativeéœ€è¦è‡ªå·±ä¿®æ”¹æºç </p>
<p>ä¸¤è€…åœ¨åŠŸèƒ½ä¸Šå¹¶æ— ç»å¯¹çš„ä¼˜åŠ£ã€‚åœ¨å¼€å‘å‚¬æ”¶çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°å¾ˆå¤šå¸¸è§çš„åŠŸèƒ½RNæ²¡æœ‰æ”¯æŒï¼Œä½†æ˜¯æˆ‘ä»¬é€šè¿‡ä¸€ç‚¹ç‚¹æ‘¸ç´¢éƒ½èƒ½è‡ªå·±æ‰©å±•å‡ºæ¥ã€‚RNåœ¨åº•å±‚çš„nativeä»£ç éƒ½æ˜¯ä¸€ä¸ªä¸ªmoduleï¼Œå¯ä»¥æ ¹æ®å¼€å‘éœ€è¦çµæ´»æ‰©å±•æ’æ‹”ã€‚åŸºæœ¬ä¸Šèƒ½æƒ³çš„å‡ºæ¥çš„éƒ½å¯ä»¥è‡ªå·±å®ç°ï¼Œå½“ç„¶ï¼Œæœ‰äº›å®ç°èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œå› æ­¤ï¼Œå¯¹äºRNï¼Œç›®å‰è¿˜ä¸å¤ªé€‚åˆåšé‡é‡çº§çš„äº§å“ã€‚</p>
<h4 id="weex-or-ReactNative"><a href="#weex-or-ReactNative" class="headerlink" title="weex or ReactNative"></a>weex or ReactNative</h4><p>weexçš„è¯ç”Ÿæ®è¯´æ˜¯ä¸ºäº†è§£å†³ReactNativeçš„ä¸€äº›é—®é¢˜ã€‚ç›®å‰é˜¿é‡Œåœ¨æ¨åŠ¨<code>write once run anywhere</code>çš„æ–¹é¢ä¸Šæ˜¯èµ°çš„æœ€å‰çš„ã€‚ä¸¤è€…å¯¹<code>write once run anywhere</code>æ€è€ƒï¼Œæˆ‘è®¤ä¸ºï¼Œæ˜¯å‡ºå‘é‡ç‚¹ï¼Œç»ˆç‚¹ä¸åŒã€‚RNçš„ç›®çš„æ˜¯é©å‘½Nativeç«¯ï¼Œè€Œweexåˆ™æ˜¯æƒ³æ”¹å˜H5åœ¨ç§»åŠ¨ç«¯çš„æ•ˆæœï¼Œå› æ­¤åšåˆ°äº†web,iOS,androidä¸‰å¹³å°ç»Ÿä¸€ï¼ˆRNåšä¸åˆ°webç«¯ï¼‰ã€‚å› æ­¤ï¼Œåœ¨å¼€å‘å•†ï¼Œweexç”šè‡³å¯ä»¥æŠ›å¼€nativeçš„palygroundï¼Œç›´æ¥åœ¨webä¸Šåšå¼€å‘ï¼Œç­‰åˆ°è°ƒè¯•å·®ä¸å¤šäº†ï¼Œå†åˆ°nativeä¸Šåšç»†è‡´çš„æ£€æŸ¥ã€‚</p>
<p>weexçš„å‡ºç”Ÿå†³å®šäº†ä»–ç«™åœ¨äº†å·¨äººçš„è‚©è†€ä¸Šã€‚ä¸€ä¸ª<code>devTools</code>å°±è¶³ä»¥çœ‹åˆ°weexå›¢é˜Ÿæƒ³åšå‡ºçš„æ”¹å˜ã€‚</p>
<p>ç½‘ä¸Šæœ‰äººç±»æ¯”ä¸¤è€…æ˜¯windowså’ŒLinuxçš„å…³ç³»ï¼Œè€Œæˆ‘è®¤ä¸ºåº”è¯¥æ˜¯mac OSå’ŒLinuxçš„å…³ç³»ã€‚</p>
<h2 id="JSPatch"><a href="#JSPatch" class="headerlink" title="JSPatch"></a>JSPatch</h2><h3 id="å¹³å°ä»‹ç»"><a href="#å¹³å°ä»‹ç»" class="headerlink" title="å¹³å°ä»‹ç»"></a>å¹³å°ä»‹ç»</h3><p>åŸºäºOCçš„runtimeæœºåˆ¶ï¼Œä½¿ç”¨iOSå†…ç½®çš„JavaScriptCore.frameworkä½œä¸ºJSå¼•æ“ï¼Œä»JSä¼ é€’è¦è°ƒç”¨çš„ç±»åå‡½æ•°ååˆ°Objective-Cï¼Œå†ä½¿ç”¨NSInvocationåŠ¨æ€è°ƒç”¨å¯¹åº”çš„OCæ–¹æ³•ã€‚</p>
<p>ä¼˜åŠ¿ï¼š</p>
<p>ä½¿ç”¨JSè¯­è¨€ï¼Œæ¯”ä¹‹å‰çš„ä½¿ç”¨Luaçš„<code>WXPatch</code>é€‚ç”¨æ›´å¹¿æ³›ã€‚</p>
<p>ç¬¦åˆAppleè§„åˆ™</p>
<p>å¼•æ“å°ï¼Œé™¤å»æ‰©å±•å†…å®¹ï¼Œæ ¸å¿ƒåªæœ‰ä¸‰ä¸ªæ–‡ä»¶</p>
<p>æ”¯æŒblockã€‚</p>
<h3 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>JSPatchä¹‹æ‰€ä»¥èƒ½å¤Ÿåšåˆ°é€šè¿‡JSæ¥è°ƒç”¨å’Œä¿®æ”¹OCæ–¹æ³•çš„æ ¹æœ¬åŸå› æ˜¯OCæ˜¯åŠ¨æ€è¯­è¨€ï¼ŒOCæ‰€æœ‰çš„ç±»å’Œæ–¹æ³•éƒ½çš„ç”Ÿæˆå’Œè°ƒç”¨éƒ½å¯ä»¥é€šè¿‡runtimeåœ¨è¿è¡Œæ—¶è¿›è¡Œï¼Œå› æ­¤å¯ä»¥é€šè¿‡ç±»å/æ–¹æ³•ååå°„å¾—åˆ°ç›¸åº”çš„ç±»å’Œæ–¹æ³•ã€‚</p>
<h4 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h4><p>è°ƒç”¨<code>requir</code>åï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ç±»äº†ï¼Œè¿‡ç¨‹å°±æ˜¯åœ¨JSå…¨å±€ä½œç”¨åŸŸä¸Šåˆ›å»ºä¸€ä¸ªåŒåå˜é‡ï¼Œå˜é‡æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œ</p>
<pre><code>var _require = function(clsName) {
  if (!global[clsName]) {
    global[clsName] = {
      __clsName: clsName
    }
  }
  return global[clsName]
}
</code></pre><h4 id="å°è£…JSå¯¹è±¡"><a href="#å°è£…JSå¯¹è±¡" class="headerlink" title="å°è£…JSå¯¹è±¡"></a>å°è£…JSå¯¹è±¡</h4><p>ç”±äºJSè°ƒç”¨æ²¡å®šä¹‰çš„å±æ€§æˆ–è€…æ”¾å‘çš„æ—¶å€™ä¸ä¼šè½¬å‘ï¼Œè€Œæ˜¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ä½œè€…æœ€å…ˆå¼€å§‹è€ƒè™‘çš„æ˜¯åœ¨<code>require</code>çš„æ—¶å€™å°†ç±»åä¼ å…¥OCï¼Œé€šè¿‡runtimeå°†æ•´ä¸ªç±»çš„æ–¹æ³•å’Œå±æ€§è¿”å›ç»™JSï¼ŒJSå¯¹æ¯ä¸ªæ–¹æ³•åéƒ½ç”Ÿæˆä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„å†…å®¹å°±æ˜¯å°†é€šè¿‡æ–¹æ³•åå»è°ƒç”¨OCçš„æ–¹æ³•å®ç°ã€‚</p>
<p>ç„¶è€Œè¿™ç§æ–¹æ³•å®ç°ä¼šé€ æˆå·¨å¤§æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºé™¤äº†è¦éå†å½“å‰ç±»çš„æ–¹æ³•ï¼Œè¿˜è¦éå†çˆ¶ç±»ä¸€ç›´åˆ°æ ¹ç±»æ‰€æœ‰ç»§æ‰¿é“¾ä¸Šçš„æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨å¼•å…¥å‡ ä¸ªç±»ä»¥åå°±é€ æˆå†…å­˜æš´æ¶¨ã€‚ä½œè€…ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæƒ³å‡ºåœ¨ OC æ‰§è¡Œ JS è„šæœ¬å‰ï¼Œé€šè¿‡æ­£åˆ™æŠŠæ‰€æœ‰æ–¹æ³•è°ƒç”¨éƒ½æ”¹æˆè°ƒç”¨ __c() å‡½æ•°ï¼Œå†æ‰§è¡Œè¿™ä¸ª JS è„šæœ¬ï¼Œåšåˆ°äº†ç±»ä¼¼ OC/Lua/Ruby ç­‰çš„æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼š</p>
<pre><code>UIView.alloc().init()
-&gt;
UIView.__c(&#39;alloc&#39;)().__c(&#39;init&#39;)()
</code></pre><p>ç»™ JS å¯¹è±¡åŸºç±» Object åŠ ä¸Š <strong>c æˆå‘˜ï¼Œè¿™æ ·æ‰€æœ‰å¯¹è±¡éƒ½å¯ä»¥è°ƒç”¨åˆ° </strong>cï¼Œæ ¹æ®å½“å‰å¯¹è±¡ç±»å‹åˆ¤æ–­è¿›è¡Œä¸åŒæ“ä½œï¼š</p>
<pre><code>Object.defineProperty(Object.prototype, &#39;__c&#39;, {value: function(methodName) {
  if (!this.__obj &amp;&amp; !this.__clsName) return this[methodName].bind(this);
  var self = this
  return function(){
    var args = Array.prototype.slice.call(arguments)
    return _methodFunc(self.__obj, self.__clsName, methodName, args, self.__isSuper)
  }
}})
</code></pre><h4 id="æ¶ˆæ¯ä¼ é€’"><a href="#æ¶ˆæ¯ä¼ é€’" class="headerlink" title="æ¶ˆæ¯ä¼ é€’"></a>æ¶ˆæ¯ä¼ é€’</h4><p>æ˜¯ç”¨äº†JSCoreçš„æ¥å£ï¼Œåœ¨å¯åŠ¨JSPatchçš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ª<code>JSContext</code>å®ä¾‹ï¼Œ<code>JSContext</code>æ˜¯JSçš„æ‰§è¡Œç¯å¢ƒï¼Œå¯ä»¥ç»™<code>JSContext</code>æ·»åŠ æ–¹æ³•ï¼ŒJSå¯ä»¥ç›´æ¥è°ƒç”¨ã€‚</p>
<pre><code>JSContext *context = [[JSContext alloc] init];
context[@&quot;hello&quot;] = ^(NSString *msg) {
    NSLog(@&quot;hello %@&quot;, msg);
};
[_context evaluateScript:@&quot;hello(&#39;word&#39;)&quot;];     //output hello word
</code></pre><p>JS é€šè¿‡è°ƒç”¨ JSContext å®šä¹‰çš„æ–¹æ³•æŠŠæ•°æ®ä¼ ç»™ OCï¼ŒOC é€šè¿‡è¿”å›å€¼ä¼ ä¼šç»™ JSã€‚è°ƒç”¨è¿™ç§æ–¹æ³•ï¼Œå®ƒçš„å‚æ•°/è¿”å›å€¼ JavaScriptCore éƒ½ä¼šè‡ªåŠ¨è½¬æ¢ï¼ŒOC é‡Œçš„ NSArray, NSDictionary, NSString, NSNumber, NSBlock ä¼šåˆ†åˆ«è½¬ä¸ºJSç«¯çš„æ•°ç»„/å¯¹è±¡/å­—ç¬¦ä¸²/æ•°å­—/å‡½æ•°ç±»å‹ã€‚</p>
<h4 id="å¯¹è±¡æŒæœ‰è½¬æ¢"><a href="#å¯¹è±¡æŒæœ‰è½¬æ¢" class="headerlink" title="å¯¹è±¡æŒæœ‰è½¬æ¢"></a>å¯¹è±¡æŒæœ‰è½¬æ¢</h4><p>å¯¹äºä¸€ä¸ªè‡ªå®šä¹‰idå¯¹è±¡ï¼ŒJavaScriptCore ä¼šæŠŠè¿™ä¸ªè‡ªå®šä¹‰å¯¹è±¡çš„æŒ‡é’ˆä¼ ç»™ JSï¼Œè¿™ä¸ªå¯¹è±¡åœ¨ JS æ— æ³•ä½¿ç”¨ï¼Œä½†åœ¨å›ä¼ ç»™ OC æ—¶ OC å¯ä»¥æ‰¾åˆ°è¿™ä¸ªå¯¹è±¡ã€‚å¯¹äºè¿™ä¸ªå¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ï¼ŒæŒ‰æˆ‘çš„ç†è§£å¦‚æœJSæœ‰å˜é‡å¼•ç”¨æ—¶ï¼Œè¿™ä¸ª OC å¯¹è±¡å¼•ç”¨è®¡æ•°å°±åŠ 1 ï¼ŒJS å˜é‡çš„å¼•ç”¨é‡Šæ”¾äº†å°±å‡1ï¼Œå¦‚æœ OC ä¸Šæ²¡åˆ«çš„æŒæœ‰è€…ï¼Œè¿™ä¸ªOCå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå°±è·Ÿç€ JS èµ°äº†ï¼Œä¼šåœ¨ JS è¿›è¡Œåƒåœ¾å›æ”¶æ—¶é‡Šæ”¾ã€‚</p>
<p>ä¼ ç»™ JS çš„å˜é‡æ˜¯è¿™ä¸ª OC å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆä¹Ÿå¯ä»¥é‡æ–°ä¼ å› OCï¼Œè¦åœ¨ JS è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„æŸä¸ªå®ä¾‹æ–¹æ³•ï¼Œåªéœ€è¦åœ¨å‡½æ•°é‡ŒæŠŠè¿™ä¸ªå¯¹è±¡æŒ‡é’ˆä»¥åŠå®ƒè¦è°ƒç”¨çš„æ–¹æ³•åä¼ å›ç»™ OC å°±è¡Œäº†ã€‚</p>
<p>ç›®å‰æ²¡æ‰¾åˆ°æ–¹æ³•åˆ¤æ–­ä¸€ä¸ª JS å¯¹è±¡æ˜¯å¦è¡¨ç¤º OC æŒ‡é’ˆï¼Œè¿™é‡Œçš„è§£å†³æ–¹æ³•æ˜¯åœ¨ OC æŠŠå¯¹è±¡è¿”å›ç»™ JS ä¹‹å‰ï¼Œå…ˆæŠŠå®ƒåŒ…è£…æˆä¸€ä¸ª NSDictionaryï¼š</p>
<pre><code>static NSDictionary *_wrapObj(id obj) {
    return @{@&quot;__obj&quot;: obj};
}
</code></pre><p>è¿™æ ·åœ¨JSå¯¹è±¡é‡Œå°±å¯ä»¥å˜æˆè¿™æ ·</p>
<pre><code>{__obj: [OC Object å¯¹è±¡æŒ‡é’ˆ]}
</code></pre><h4 id="æ–¹æ³•æ›¿æ¢"><a href="#æ–¹æ³•æ›¿æ¢" class="headerlink" title="æ–¹æ³•æ›¿æ¢"></a>æ–¹æ³•æ›¿æ¢</h4><p>è¿ç”¨runtimeçš„åŸç†ï¼Œä¸å±•å¼€è®²ã€‚</p>
<h4 id="æ­»é”é—®é¢˜"><a href="#æ­»é”é—®é¢˜" class="headerlink" title="æ­»é”é—®é¢˜"></a>æ­»é”é—®é¢˜</h4><p>javaScript è¯­è¨€æ˜¯å•çº¿ç¨‹çš„ï¼Œåœ¨ OC ä½¿ç”¨ JavaScriptCore å¼•æ“æ‰§è¡Œ JS ä»£ç æ—¶ï¼Œä¼šå¯¹ JS ä»£ç å—åŠ é”ï¼Œä¿è¯åŒä¸ª JSContext ä¸‹çš„ JS ä»£ç éƒ½æ˜¯é¡ºåºæ‰§è¡Œã€‚æ‰€ä»¥è°ƒç”¨ JSPatch æ›¿æ¢çš„æ–¹æ³•ï¼Œä»¥åŠåœ¨ JSPatch é‡Œè°ƒç”¨ OC æ–¹æ³•ï¼Œéƒ½ä¼šåœ¨è¿™ä¸ªé”é‡Œæ‰§è¡Œï¼Œè¿™å¯¼è‡´ä¸‰ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>JSPatchæ›¿æ¢çš„æ–¹æ³•æ— æ³•å¹¶è¡Œæ‰§è¡Œï¼Œå¦‚æœå¦‚æœä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹åŒæ—¶è¿è¡Œäº† JSPatch æ›¿æ¢çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•çš„æ‰§è¡Œéƒ½ä¼šé¡ºåºæ’é˜Ÿï¼Œä¸»çº¿ç¨‹ä¼šç­‰å¾…å­çº¿ç¨‹çš„æ–¹æ³•æ‰§è¡Œå®Œåå†æ‰§è¡Œï¼Œå¦‚æœå­çº¿ç¨‹æ–¹æ³•è€—æ—¶é•¿ï¼Œä¸»çº¿ç¨‹ä¼šç­‰å¾ˆä¹…ï¼Œå¡ä½ä¸»çº¿ç¨‹ã€‚</li>
<li>æŸç§æƒ…å†µä¸‹ï¼ŒJavaScriptCore çš„é”ä¸ OC ä»£ç ä¸Šçš„é”æ··åˆæ—¶ï¼Œä¼šäº§ç”Ÿæ­»é”ã€‚</li>
<li>UIWebView çš„åˆå§‹åŒ–ä¼šä¸ JavaScriptCore å†²çªã€‚è‹¥åœ¨ JavaScriptCore çš„é”é‡Œ(ç¬¬ä¸€æ¬¡)åˆå§‹åŒ– UIWebView ä¼šå¯¼è‡´ webview æ— æ³•è§£æé¡µé¢ã€‚</li>
</ol>
<p>æ­»é”çš„ä¾‹å­</p>
<pre><code>
// oc

@implementation AppDelegate
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions 
{
    ClassA* obj = [[ClassA alloc] init];
    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
        //Açº¿ç¨‹
        @synchronized(obj) {    //Xé”
            sleep(3);
            [obj methodA];   //methodAè¢«JSæ›¿æ¢ï¼Œè°ƒç”¨ä¼šè¿›JSï¼Œè¯·æ±‚JSCoreçš„é”
        }
    });

    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        //Bçº¿ç¨‹
        [obj methodA];  //methodAè¢«JSæ›¿æ¢ï¼Œè°ƒç”¨ä¼šè¿›JSï¼Œè¯·æ±‚JSCoreçš„é”
    });
}
@end


@implementation ClassA
- (void)methodA
{
}
- (void)methodB
{
    @synchronized(self) {   //Xé”
        int a = 0;
    }
}
@end


// js

defineClass(&#39;ClassA&#39;, {
    methodA: function() {
        self.methodB()   //è°ƒç”¨åˆ°OCï¼Œ
    },
})
</code></pre><p>ä¸ºäº†è§£å†³æ­»é”çš„é—®é¢˜ï¼ŒJSPatchè®¾è®¡äº†<code>performSelectorInOC</code>æ–¹æ³•ã€‚</p>
<pre><code>{
    __isPerformInOC:1,
    obj:self.__obj,
    clsName:self.__clsName,
    sel: args[0],
    args: args[1],
    cb: args[2]
}
</code></pre><p>è¿”å›objåï¼ŒJSè°ƒç”¨å°±ç»“æŸäº†ã€‚åœ¨ OC å¯ä»¥æ‹¿åˆ° JS å‡½æ•°çš„è¿”å›å€¼ï¼Œä¹Ÿå°±æ‹¿åˆ°äº†è¿™ä¸ªå¯¹è±¡ï¼Œç„¶ååˆ¤æ–­å®ƒæ˜¯å¦ <code>__isPerformInOC=1</code> å¯¹è±¡ï¼Œè‹¥æ˜¯å°±æ ¹æ®å¯¹è±¡é‡Œçš„ selector / å‚æ•°ç­‰ä¿¡æ¯è°ƒç”¨å¯¹åº”çš„ OC æ–¹æ³•ï¼Œè¿™æ—¶è¿™ä¸ª OC æ–¹æ³•çš„è°ƒç”¨æ˜¯åœ¨ <code>JavaScriptCore</code> çš„é”ä¹‹å¤–è°ƒç”¨çš„ï¼Œæˆ‘ä»¬çš„ç›®çš„å°±è¾¾åˆ°äº†ã€‚<br>æ‰§è¡Œ OC æ–¹æ³•åï¼Œä¼šå»è°ƒ {obj} é‡Œçš„çš„ cb å‡½æ•°ï¼ŒæŠŠ OC æ–¹æ³•çš„è¿”å›å€¼ä¼ ç»™ cb å‡½æ•°ï¼Œé‡æ–°å›åˆ° JS å»æ‰§è¡Œä»£ç ã€‚è¿™é‡Œä¼šå¾ªç¯åˆ¤æ–­è¿™äº›å›è°ƒå‡½æ•°æ˜¯å¦è¿˜è¿”å› <code>__isPerformInOC=1</code> çš„å¯¹è±¡ï¼Œè‹¥æ˜¯åˆ™é‡å¤ä¸Šè¿°æµç¨‹æ‰§è¡Œï¼Œä¸æ˜¯åˆ™ç»“æŸã€‚</p>
<h3 id="å®‰å…¨é—®é¢˜"><a href="#å®‰å…¨é—®é¢˜" class="headerlink" title="å®‰å…¨é—®é¢˜"></a>å®‰å…¨é—®é¢˜</h3><h4 id="ä¼ è¾“å®‰å…¨"><a href="#ä¼ è¾“å®‰å…¨" class="headerlink" title="ä¼ è¾“å®‰å…¨"></a>ä¼ è¾“å®‰å…¨</h4><p>JS è„šæœ¬å¯ä»¥è°ƒç”¨ä»»æ„ OC æ–¹æ³•ï¼Œæƒé™éå¸¸å¤§ï¼Œè‹¥è¢«ä¸­é—´äººæ”»å‡»æ›¿æ¢ä»£ç ï¼Œä¼šé€ æˆè¾ƒå¤§çš„å±å®³ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆ å¯¹ç§°åŠ å¯†ï¼ŒHTTPSï¼ŒRSAæ ¡éªŒ</p>
<p>æœ‰èƒ½åŠ›ä¸ŠHTTPSï¼Œç®€å•å®‰å…¨ç”¨RSAï¼Œä¸æ¨èå¯¹ç§°åŠ å¯†ã€‚</p>
<h4 id="æ‰§è¡Œå®‰å…¨"><a href="#æ‰§è¡Œå®‰å…¨" class="headerlink" title="æ‰§è¡Œå®‰å…¨"></a>æ‰§è¡Œå®‰å…¨</h4><p>ä¸‹å‘çš„ JS è„šæœ¬çµæ´»åº¦å¤§ï¼Œç›¸å½“äºä¸€æ¬¡å°å‹æ›´æ–°ï¼Œè‹¥æœªè¿›è¡Œå……åˆ†æµ‹è¯•ï¼Œå¯èƒ½ä¼šå‡ºç° crash ç­‰æƒ…å†µå¯¹ APP ç¨³å®šæ€§é€ æˆå½±å“ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼šç°åº¦ï¼Œç›‘æ§ï¼Œå›é€€</p>
<p>å›é€€æ˜¯æ¨èæ‰€æœ‰APPéƒ½æ¥å…¥ï¼Œç°åº¦å’Œç›‘æ§å®¤ä¸­å¤§å‹APPè¦è€ƒè™‘çš„</p>
<h4 id="å¯¹æ¯”RN-weexçš„ä¼˜åŠ¿"><a href="#å¯¹æ¯”RN-weexçš„ä¼˜åŠ¿" class="headerlink" title="å¯¹æ¯”RN/weexçš„ä¼˜åŠ¿"></a>å¯¹æ¯”RN/weexçš„ä¼˜åŠ¿</h4><ol>
<li>å°å·§ã€‚åªéœ€å¼•å…¥ JPEngine.h JPEngine.m JSPatch.js ä¸‰ä¸ªå°æ–‡ä»¶ï¼Œä½“ç§¯å°å·§ï¼Œä¹Ÿæ— éœ€æ­å»ºç¯å¢ƒã€‚</li>
<li>å­¦ä¹ æˆæœ¬ä½ã€‚å¯ä»¥ç»§ç»­æ²¿ç”¨åŸæ¥ OC çš„æ€ç»´å†™ç¨‹åºï¼Œæ— éœ€å­¦ä¹ æ–°ä¸€å¥—è§„åˆ™ï¼Œå³åˆ»ä¸Šæ‰‹ã€‚</li>
<li>é™åˆ¶å°‘ã€‚å¯ä»¥è¯´å®Œå…¨æ²¡æœ‰é™åˆ¶ï¼ŒOC / JS ä¸Šç©å‡ºèŠ±çš„å„ç§æ¨¡å¼éƒ½å¯ä»¥ç…§æ¬ä½¿ç”¨ï¼Œä¸ä¼šè¢«æŸä¸€æ¡†æ¶æ€ç»´å’Œå†™æ³•é™å®šã€‚æ‰€æœ‰ OC / JS åº“ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€é€‚é…ã€‚</li>
</ol>
<p>##ä¸ªäººè§‚ç‚¹</p>
<h3 id="RN-vs-weex"><a href="#RN-vs-weex" class="headerlink" title="RN vs weex"></a>RN vs weex</h3><h4 id="å¼€å‘APP"><a href="#å¼€å‘APP" class="headerlink" title="å¼€å‘APP"></a>å¼€å‘APP</h4><p>RNçš„ä¼˜åŠ¿æ— ç–‘æ˜¯å›½é™…å¤§å‚facebookçš„é¼åŠ›æ”¯æŒå’Œå¼€æºç¤¾åŒºæé«˜çš„çƒ­æƒ…ã€‚RNçš„å‡ºç”Ÿçš„ç›®çš„å·²ç»å†³å®šäº†ä»–æœªæ¥çš„æ–¹å‘ï¼šæ›¿ä»£Nativeå¼€å‘ã€‚RNçš„åŸºç¡€æ¶æ„è®¾è®¡è®©RNå…·æœ‰æ— çº¿çš„å¯èƒ½ï¼Œèƒ½ç”¨Nativeåšåˆ°çš„ï¼ŒRNéƒ½èƒ½åšåˆ°ã€‚ç„¶è€Œï¼Œå¤§è€Œå…¨ä¹Ÿæ„å‘³ç€å‰è¿›å›°éš¾ï¼Œç›®å‰RNä»ç„¶æœªå‘å¸ƒ1.0ç‰ˆæœ¬ï¼Œfacebookè‡ªèº«ä¹Ÿä»…ä»…åœ¨å‡ ä¸ªç”¨æˆ·é‡è¾ƒå°çš„APPä¸Šä½¿ç”¨ã€‚Nativeç«¯å…¼å®¹é—®é¢˜å’Œæ€§èƒ½é—®é¢˜éƒ½è¿˜æ²¡èƒ½å¾ˆå¥½çš„è§£å†³ã€‚å› æ­¤ï¼Œä½¿ç”¨RNå¼€å‘ï¼Œç›®å‰ä»…ä»…é€‚åˆé‡çº§å°ï¼ŒåŠŸèƒ½ç®€å•çš„APPï¼ŒåŒæ—¶è¿˜éœ€è¦ä¸€å®šé‡æœ‰Web,nativeæ®µç»éªŒçš„å·¥ç¨‹å¸ˆä¸€åŒè¸©å‘ã€‚</p>
<p>weexæ˜¯å›½å†…å¤§å‚é˜¿é‡Œçš„ä½œå“ï¼Œä»å†å²ä¸Šæ¥çœ‹ï¼Œé˜¿é‡Œå¼€æºäº†å¾ˆå¤šä¹Ÿå¼ƒå‘äº†å¾ˆå¤šï¼Œå¯¹äºweexè¿™ä¸ªåˆšå¼€æºå‡ºæ¥çš„æ¡†æ¶ï¼Œå¤šæ•°äººè¿˜æ˜¯æŠ±ç€è°¨æ…ä¹è§‚çš„æ€åº¦ã€‚ä»ä¸€äº›å…¬å¼€æŠ€æœ¯åˆ†äº«ä¸Šæ¥çœ‹ï¼Œé˜¿é‡Œåœ¨weexä¸ŠæŠ•å…¥äº†å¾ˆå¤šäººåŠ›ï¼Œä¹Ÿæ˜¯å› ä¸ºç§»åŠ¨ç«¯å’Œwebçš„ä¸šåŠ¡å‘å±•å¯¼è‡´çš„ã€‚ç›®å‰weexæ”¯æŒçš„ç»„ä»¶å’ŒåŠŸèƒ½éƒ½æ˜¯éå¸¸åŸºç¡€å•ä¸€çš„ï¼Œç”šè‡³å¾ˆå¤šå¿…è¦çš„åŠŸèƒ½éƒ½æ²¡æœ‰å®ç°ï¼Œç¤¾åŒºæ´»è·ƒåº¦ä¸é«˜ä¹Ÿå¯¼è‡´å¾ˆå¤šå‘å¯èƒ½éœ€è¦è‡ªå·±æ…¢æ…¢çœ‹æºç å»è¸©ã€‚ä¸è¿‡ï¼Œweexç«™åœ¨RNå·¨äººçš„è‚©è†€ä¸Šï¼Œä¸°å¯Œçš„å¼€å‘å·¥å…·é“¾ï¼Œæä¾›äº†æ›´ä¾¿æ·çš„è°ƒè¯•å·¥å…·å’ŒplayGroundã€‚ç›®å‰æ¥çœ‹ï¼Œå¦‚æœé˜¿é‡Œæ„¿æ„æŠ•å…¥æ›´å¤šåŠ›é‡ï¼Œå·å¬å¼€æºç¤¾åŒºåšè´¡çŒ®ï¼Œæœªå¿…ä¸èƒ½ä¸RNä¸€è¾ƒé«˜ä¸‹ã€‚ç›®å‰æ¥çœ‹ï¼Œweexä»…é€‚åˆç”¨äºåšéå¸¸ç®€å•çš„demoï¼ˆæ¯”å¦‚ä¸€äº›å¥—å£³H5ï¼‰ï¼Œè¿˜ä¸é€‚åˆåšå®Œæ•´åŠŸèƒ½çš„APPã€‚</p>
<h4 id="hot-fix"><a href="#hot-fix" class="headerlink" title="hot fix"></a>hot fix</h4><p>ä¸¤ä¸ªæ¡†æ¶éƒ½é€‚åˆåšçƒ­æ›´æ–°ï¼Œä»è¿™æ–¹é¢çœ‹ï¼Œä¸¤è€…æ²¡æœ‰ä¼˜åŠ£åŒºåˆ«ã€‚ä¸¤è€…éƒ½åªèƒ½æ”¹å˜å·²ç»å®ç°çš„éƒ¨åˆ†ï¼Œä¸èƒ½æ·»åŠ æˆ–è€…ä¿®æ”¹å·²ç»å­˜åœ¨çš„æ–¹æ³•ã€‚</p>
<h3 id="JSPatch-vs-RN-amp-weex"><a href="#JSPatch-vs-RN-amp-weex" class="headerlink" title="JSPatch vs RN&amp;weex"></a>JSPatch vs RN&amp;weex</h3><h4 id="å¼€å‘APP-1"><a href="#å¼€å‘APP-1" class="headerlink" title="å¼€å‘APP"></a>å¼€å‘APP</h4><p>ç”¨JSPatchå»å¼€å‘ä¸€ä¸ªAPPæœ‰æ²¡æœ‰ï¼Œæœ‰ï¼Œä½†æ˜¯ç›®å‰æˆ‘çœ‹åˆ°çš„ï¼Œåªæœ‰ä¸¤ä¸ªå¼€æºçš„å°é¡¹ç›®ã€‚ä»ä½œè€…çš„è§‚ç‚¹æ¥çœ‹ï¼ŒJSPatchå¯ä»¥ç”¨æ¥å¼€å‘ä¸€ä¸ªå•ç‹¬çš„æ¨¡å—ï¼Œä½†æ˜¯ä¸é€‚åˆå¼€å‘ä¸€æ•´ä¸ªAPPã€‚æ¯•ç«Ÿï¼ŒJSPatchçš„æ€è·¯ä¾ç„¶æ˜¯ç”±nativeçš„æ€ç»´ç”¨JSæ¥å¼€å‘ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œä¸å¦‚ç›´æ¥ç”¨OCå¼€å‘æ›´åŠ ç›´æ¥ã€‚ä½†ç”±äºOCå¼ºå¤§æ— æ¯”çš„runtimeï¼ŒJSPatchå¯ä»¥ç”¨äºå¼€å‘ä¸€ä¸ªå…¨æ–°çš„é¡µé¢å»æ›¿ä»£åŸæœ¬ä½¿ç”¨Nativeç¼–å†™çš„é¡µé¢ï¼Œè¿™ä¸€ç‚¹æ˜¯RNå’Œweexåšä¸åˆ°çš„ã€‚</p>
<h4 id="hot-patch"><a href="#hot-patch" class="headerlink" title="hot patch"></a>hot patch</h4><p>JSPatchçš„å‡ºç”Ÿå°±æ˜¯ä¸ºäº†è§£å†³iOSå‘ç‰ˆå›°éš¾çš„é—®é¢˜ï¼ŒåŸºäºOCçš„runtimeå’Œjsçš„çµæ´»ä½¿JSPatchåœ¨çƒ­ä¿®å¤ä¸Šæ¯”RN/weexå¼ºä¸Šäº†ä¸€ä¸ªé‡çº§ã€‚ä¸¾ä¸¤ä¸ªä¾‹å­</p>
<p>ä¸€ï¼šå®ç°ä¸€ä¸ªæ²¡æœ‰å®ç°çš„åŠŸèƒ½ã€‚</p>
<p>RN/weexéƒ½éœ€è¦å®ç°ä¸€ä¸ªjsBrideï¼Œå°±æ˜¯åœ¨nativeå®ç°å¥½ï¼Œç”¨jså»è°ƒç”¨ã€‚è¿™æ ·çš„æ–¹å¼å°±æ— æ³•åŠ¨æ€çš„æ·»åŠ æ–¹æ³•ï¼Œæ¯”å¦‚æˆ‘ä»¬ç°åœ¨ä¸ƒè´·åšäº†ä¸ªå¾®ä¿¡åˆ†äº«ï¼Œç æ‰äº†ä¸€ä¸ªæ‹·è´é“¾æ¥çš„æŒ‰é’®ã€‚ç”¨JSPatchå°±å¯ä»¥å¾ˆå¿«çš„åŠ å›å»ï¼Œä¸éœ€è¦å‘ç‰ˆæœ¬ï¼Œè€Œå¦‚æœæ˜¯ç”¨RNå¼€å‘çš„ï¼ŒNativeåŸæœ¬å°±æ²¡æœ‰å®ç°è¿™æ®µä»£ç ï¼Œé‚£å°±æ— èƒ½ä¸ºåŠ›äº†ã€‚</p>
<p>äºŒï¼šæ›¿æ¢åŸç”Ÿçš„é¡µé¢</p>
<p>å¾ˆå¤šé¡¹ç›®æœ¬èº«å·²ç»ä½¿ç”¨Nativeå¼€å‘ä¸€æ®µæ—¶é—´äº†ï¼Œæ¥å…¥RN/weexåä¹Ÿåªæ˜¯å±€éƒ¨æ–°é¡µé¢ä½¿ç”¨ã€‚RNå¯ä»¥å¼€å‘ä¸€æ•´ä¸ªæ–°åŠŸèƒ½ç•Œé¢ï¼ŒåŠ¨æ€æ›´æ–°åˆ°appä¸Šï¼Œä½†æ˜¯è¿™ä¸ªæ–°åŠŸèƒ½ç•Œé¢æ€ä¹ˆæ‰“å¼€å‘¢ï¼ŸåŠæ³•æœ‰ä¸€ä¸ªï¼Œappå†…æœ‰ä¸€å¥—URLRouteçš„è·¯ç”±æœºåˆ¶ï¼Œå¹¶ä¸”è¾…åŠ©ä»¥äº‘ç«¯å¯æ§çš„è·¯ç”±é…ç½®è¡¨ï¼Œé‚£ä¹ˆç¡®å®å¯ä»¥æ”¹å˜æŸäº›ä½ç½®åŸæœ¬çš„ç•Œé¢è·³è½¬ï¼Œä»è€Œè·³è½¬æ‰“å¼€å…¨æ–°çš„RNç•Œé¢ï¼Œå®ç°äº†æ–°RNç•Œé¢çš„åŠ¨æ€æ›´æ–°ï¼Œä½†æ˜¯JSPatchå°±ä¸éœ€è¦URLRouteè¿™å¥—å…¨å±€è·³è½¬çš„è¾…åŠ©æœºåˆ¶å¸®å¿™ï¼ŒJSPatchå®Œå…¨æœ‰èƒ½åŠ›æ›´æ”¹ä»»ä½•å·²ç»ç”±OCå†™å¥½çš„ä»£ç ï¼Œéšæ„çš„æ”¹å˜è·³è½¬åˆ°æ–°ç•Œé¢ï¼Œéšæ„çš„å¢åŠ æ–°æŒ‰é’®ï¼Œä¸æ”¹å˜æ—§ç•Œé¢å°±æŠŠæ–°ç•Œé¢æ‰“å¼€ï¼</p>
<h4 id="å†…å­˜æ§åˆ¶å·®å¼‚"><a href="#å†…å­˜æ§åˆ¶å·®å¼‚" class="headerlink" title="å†…å­˜æ§åˆ¶å·®å¼‚"></a>å†…å­˜æ§åˆ¶å·®å¼‚</h4><p>JSPatchåœ¨OCå’ŒJCäº¤äº’çš„æ—¶å€™ï¼Œå°†OCå¯¹è±¡ï¼Œç•Œé¢ï¼ŒModelç›´æ¥ä¼ ç»™JSçš„ä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¼š+1ï¼Œå¹¶éšç€JSçš„åƒåœ¾å›æ”¶è€Œå¯¹è¿™ä¸ªOCå¯¹è±¡è¿›è¡Œé¢å¤–çš„æ§åˆ¶ã€‚JSä¸­æ— æ³•è®¿é—®è¿™ä¸ªOCå¯¹è±¡ï¼Œä½†å¯ä»¥å°†OCå¯¹è±¡çš„æ–¹æ³•å‘å›ç»™OCç¯å¢ƒå»æ“ä½œã€‚</p>
<p>RNåœ¨OCä¸JSäº¤äº’çš„æ—¶å€™ï¼Œæ˜¯å®Œå…¨ä¸æ”¯æŒä¼ é€’ä»»ä½•OCå¯¹è±¡çš„ï¼Œæ‰€æœ‰èƒ½åœ¨JSä¸OCä¸­é—´ä¼ é€’çš„ï¼Œä¸€å®šæ˜¯å¯ä»¥è¢«jsonåŒ–ï¼Œå­—ç¬¦åŒ–çš„å†…å®¹ï¼Œæ•°å­—ï¼Œå­—å…¸ï¼Œæ•°ç»„ï¼Œå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥RNä¸“é—¨æœ‰ä¸ªRCTConvertç±»å»ä¸“é—¨å¤„ç†ï¼Œjsonçš„åºåˆ—åŒ–modelåŒ–ï¼Œååºåˆ—åŒ–åmodelåŒ–ã€‚é‚£ä¹ˆRNæ˜¯å¦‚ä½•é€šè¿‡JSå»æ§åˆ¶ä¸€ä¸ªçº¯OCçš„ç•Œé¢Viewå‘¢?æ˜¯é€šè¿‡viewTagï¼ŒJSæ§åˆ¶çš„æ¯ä¸€ä¸ªç•Œé¢æ•ˆæœï¼Œéƒ½æ˜¯ä¼ è¿‡æ¥ä¸€ä¸ªtagï¼Œè®©nativeåˆ›å»ºï¼Œè®©nativeä¿®æ”¹ï¼Œnativeä¼šå‚¨å­˜ä½è¿™äº›tagåˆ°ä¸€ä¸ªhashmapé‡Œï¼Œè¿™æ ·JSæ‰èƒ½å¤Ÿä¸ç›´æ¥ä¼ é€’OCå¯¹è±¡ï¼Œè€Œæ˜¯ä¼ é€’ä¸€ä¸ªæ•°å­—ï¼Œä»è€Œæ§åˆ¶OCå¯¹è±¡</p>
<blockquote>
<p>äºŒè€…çš„å®ç°å·®å¼‚ï¼Œæ˜¯ä¼šé€ æˆä¸€äº›åº•å±‚è¿è¡Œå·®å¼‚çš„ï¼ŒOCä¸JSå¯¹è±¡åªä¼ é€’JSONå…¶å®å°±ä¿è¯äº†ï¼ŒJSä¸Šä¸‹æ–‡çš„å†…å­˜ä¸OCä¸Šä¸‹æ–‡çš„å†…å­˜å®Œå…¨æ²¡æœ‰äº’é€šï¼Œå„è‡ªçš„å†…ä»å„è‡ªæ§åˆ¶ï¼ŒJSæ˜¯ä¸€å¥—åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œè€ŒOCæ˜¯ä¸€å¥—å¼•ç”¨è®¡æ•°æœºåˆ¶ã€‚</p>
<p>JSPatchå°†äºŒè€…è¿›è¡Œäº†äº’é€šï¼Œè¿™äº›äº’é€šçš„å¯¹è±¡å†…å­˜ç®¡ç†åˆ™æ˜¯ä¸€å¥—ï¼Œåˆæœ‰å¼•ç”¨è®¡æ•°æ§åˆ¶ï¼Œåˆæœ‰JSçš„åƒåœ¾å›æ”¶ï¼Œå½“JSçš„åƒåœ¾å›æ”¶ï¼Œå¹¶ä¸”iOSçš„å¼•ç”¨è®¡æ•°å½’0ï¼Œæ‰ä¼šé”€æ¯ã€‚</p>
<p>è¿™é‡Œæ²¡æœ‰ä¼˜åŠ£ä¹‹åˆ†ï¼ŒJSPatchåœ¨åŒå†…å­˜æ§åˆ¶æœºåˆ¶ä¸‹ï¼Œä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸workæ²¡æœ‰é—®é¢˜çš„ï¼ŒRN&amp;Weexçš„è¿™å¥—æœºåˆ¶ï¼Œå†…å­˜ä¸Šç®€å•æ¸…æ™°ï¼Œä¸è¿‡è¿™éƒ½æ˜¯åº•å±‚å®ç°çš„é—®é¢˜ï¼Œä¸Šå±‚ä½¿ç”¨ï¼Œéƒ½æ˜¯æ²¡é—®é¢˜çš„</p>
</blockquote>
<p>##æ€»ç»“</p>
<p>è¿™é‡Œå€Ÿç”¨JSPatch ä½œè€…ç»™å‡ºçš„ä¸€ä¸ªæ¯”è¾ƒã€‚</p>
<table>
<thead>
<tr>
<th>æ¡†æ¶</th>
<th>å­¦ä¹ æˆæœ¬</th>
<th>æ¥å…¥æˆæœ¬</th>
<th>å¼€å‘æ•ˆç‡</th>
<th>æ€§èƒ½ä½“éªŒ</th>
<th>çƒ­æ›´æ–°èƒ½åŠ›</th>
</tr>
</thead>
<tbody>
<tr>
<td>RN&amp;Weex</td>
<td>é«˜</td>
<td>é«˜</td>
<td>é«˜ï¼Œè·¨å¹³å°</td>
<td>é«˜</td>
<td>ä¸­</td>
</tr>
<tr>
<td>JSPatch</td>
<td>ä½</td>
<td>ä½</td>
<td>ä¸­ï¼Œå•ä¸€iOS</td>
<td>é«˜</td>
<td>å¾ˆå¼º</td>
</tr>
</tbody>
</table>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://p3.pstatp.com/large/ab000310321818ab99.jpg"
               alt="csbzhixing" />
          <p class="site-author-name" itemprop="name">csbzhixing</p>
          <p class="site-description motion-element" itemprop="description">ä¹‹è¡Œçš„åšå®¢</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">30</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/csbzhixing" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/csbzhixing/activities" target="_blank" title="çŸ¥ä¹">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  çŸ¥ä¹
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">csbzhixing</span>
</div>


<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.0"></script>



</body>
</html>
